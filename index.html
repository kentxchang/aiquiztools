<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂâõÂ•ΩÊ∏¨</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Ë®≠ÂÆö PDF.js worker
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        /* Ëá™ÂÆöÁæ©Êç≤Ëª∏ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        /* ÂãïÁï´ */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out forwards; }
        
        /* Modal ÂãïÁï´ */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: scale(0.95); }
        
        /* ÂïüÁî®ÁãÄÊÖãÂãïÁï´ */
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .active-pulse { animation: pulse-ring 2s infinite; }

        /* Details Summary Remove Marker */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }

        /* --- New Highlighter Styles --- */
        .passage-content mark {
            background-color: transparent; /* Remove default browser style */
            padding: 0;
            margin: 0;
            border-radius: 3px;
            color: black !important; /* Force black text for high contrast */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2); /* Subtle text shadow */
            border: 2px solid; /* Add a border */
        }
        .highlight-yellow { 
            background-color: rgb(255, 255, 0) !important;
            border-color: rgb(200, 200, 0); /* Darker yellow border */
        }
        .highlight-green { 
            background-color: rgb(128, 255, 0) !important;
            border-color: rgb(80, 200, 0); /* Darker green border */
        }
        .highlight-pink { 
            background-color: rgb(255, 0, 150) !important;
            border-color: rgb(200, 0, 100); /* Darker pink border */
        }
        
        .passage-content .highlight-yellow,
        .passage-content .highlight-green,
        .passage-content .highlight-pink {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen text-slate-800">

<div id="app" class="relative min-h-screen flex flex-col">

    <!-- ‰∏ªÂÖßÂÆπÂçÄ -->
    <div class="flex-grow flex flex-col">
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md sticky top-0 z-30 border-b border-slate-200">
            <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-2 cursor-pointer" @click="goToView('landing')">
                    <div class="w-8 h-8 bg-gradient-to-br from-pink-500 to-violet-600 rounded-lg flex items-center justify-center text-white font-bold">Q</div>
                    <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-600 to-violet-600">ÂâõÂ•ΩÊ∏¨</h1>
                </div>
                <div class="flex items-center gap-3">
                    <button v-if="!isStudentView" @click="toggleSettings" class="p-2 text-slate-500 hover:text-violet-600 transition" title="Á≥ªÁµ±Ë®≠ÂÆö">
                        <i class="fa-solid fa-gear text-lg"></i>
                    </button>
                    <!-- ÈÄ£Á∑öÁãÄÊÖãÊåáÁ§∫Ááà -->
                    <div v-if="isConfigured && user" class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full flex items-center">
                        <i class="fa-solid fa-circle text-[8px] mr-1"></i>Â∑≤ÈÄ£Á∑ö
                    </div>
                    <button v-else @click="showSettingsModal = true" class="text-xs px-2 py-1 bg-red-100 text-red-700 rounded-full flex items-center animate-pulse hover:bg-red-200 transition">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i>Êú™ÈÄ£Á∑ö (ÈªûÊ≠§Ë®≠ÂÆö)
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow w-full max-w-6xl mx-auto p-4 sm:p-6">
            
            <!-- VIEW: Landing Page -->
            <transition name="fade" mode="out-in">
                <div v-if="currentView === 'landing'" class="h-full flex flex-col items-center justify-center py-10">
                    <div class="text-center mb-12">
                        <h2 class="text-4xl md:text-5xl font-bold text-slate-800 mb-4">Ê≠°Ëøé‰æÜÂà∞ ÂâõÂ•ΩÊ∏¨</h2>
                        <p class="text-lg text-slate-500">ËÄÅÂ∏´ËºïÈ¨ÜÂá∫È°åÔºåÂ≠∏ÁîüÂø´Ê®ÇÂ≠∏Áøí</p>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-8 w-full" :class="isStudentView ? 'md:max-w-md' : 'md:grid-cols-2 md:max-w-4xl'">
                        <!-- Â≠∏ÁîüÂÖ•Âè£ -->
                        <div @click="checkConfigAndGo('student-login')" class="group bg-white p-8 rounded-3xl shadow-xl hover:shadow-2xl transition cursor-pointer border border-slate-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-sky-100 rounded-full -mr-16 -mt-16 group-hover:scale-110 transition duration-500"></div>
                            <div class="relative z-10">
                                <div class="w-16 h-16 bg-sky-100 text-sky-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-sky-600 group-hover:text-white transition">
                                    <i class="fa-solid fa-graduation-cap"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-slate-800 mb-2">ÊàëÊòØÂ≠∏Áîü</h3>
                                <p class="text-slate-500">Ëº∏ÂÖ•ÂßìÂêçÔºåÁ´ãÂç≥Âä†ÂÖ•ËÄÅÂ∏´ÁöÑÊ∏¨È©ó</p>
                            </div>
                        </div>

                        <!-- ÊïôÂ∏´ÂÖ•Âè£ -->
                        <div v-if="!isStudentView" @click="checkConfigAndGo('teacher-login')" class="group bg-white p-8 rounded-3xl shadow-xl hover:shadow-2xl transition cursor-pointer border border-slate-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-pink-100 rounded-full -mr-16 -mt-16 group-hover:scale-110 transition duration-500"></div>
                            <div class="relative z-10">
                                <div class="w-16 h-16 bg-pink-100 text-pink-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-pink-600 group-hover:text-white transition">
                                    <i class="fa-solid fa-chalkboard-user"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-slate-800 mb-2">ÊàëÊòØËÄÅÂ∏´</h3>
                                <p class="text-slate-500">AI ËºîÂä©Âá∫È°åÔºåÂïüÁî®Ê∏¨È©óËàáÂàÜÊûê</p>
                            </div>
                        </div>
                    </div>

                    <!-- ÊéàÊ¨äË≥áË®ä -->
                    <div class="mt-12 text-center text-sm text-slate-600 max-w-2xl mx-auto">
                        <p class="mb-2">
                            Êú¨‰ΩúÂìÅÊé°Áî® <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" class="text-violet-600 hover:text-violet-700 font-medium underline">CC BY-NC-SA 4.0 ÂâµÁî®CCÊéàÊ¨ä</a>„ÄÇ
                        </p>
                        <p class="text-slate-500">
                            Ê≠°ËøéÈùûÂïÜÊ•≠Áî®ÈÄîËΩâËºâ„ÄÅÂºïÁî®ÊàñÊîπÁ∑®,Ë´ã‰øùÁïô„ÄåÈòøÂâõËÄÅÂ∏´„ÄçÁΩ≤Âêç,‰∏¶ÈôÑ‰∏äÊú¨‰ΩúÂìÅÂéüÂßãÈÄ£Áµê„ÄÇ
                        </p>
                    </div>
                </div>

                <!-- VIEW: Teacher Login -->
                <div v-else-if="currentView === 'teacher-login'" class="flex items-center justify-center py-20">
                    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full text-center">
                        <div class="mb-6 inline-block p-4 bg-pink-100 text-pink-500 rounded-full text-3xl">
                            <i class="fa-solid fa-lock"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-4">ÊïôÂ∏´Â∞àÁî®ÂÖ•Âè£</h3>
                        <input type="password" v-model="teacherPassword" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º" 
                            class="w-full p-3 border border-slate-200 rounded-xl mb-4 focus:ring-2 focus:ring-pink-500 outline-none text-center">
                        <button @click="verifyTeacher" class="w-full py-3 bg-pink-500 text-white rounded-xl font-bold hover:bg-pink-600 transition">ÈÄ≤ÂÖ•ÁÆ°ÁêÜÂæåÂè∞</button>
                        <button @click="goToView('landing')" class="mt-4 text-slate-400 text-sm hover:text-slate-600">ËøîÂõûÈ¶ñÈ†Å</button>
                    </div>
                </div>

                <!-- VIEW: Teacher Dashboard -->
                <div v-else-if="currentView === 'teacher-dashboard'" class="space-y-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">ÊïôÂ∏´ÁÆ°ÁêÜÂÑÄË°®Êùø</h2>
                            <p class="text-slate-500">ÁÆ°ÁêÜÊÇ®ÁöÑÈ°åÂ∫´ËàáÊ∏¨È©óÁãÄÊÖã</p>
                        </div>
                        <div class="flex gap-2">
                             <button @click="openCreateModal" class="px-5 py-2.5 bg-violet-600 text-white rounded-xl font-medium shadow-lg shadow-violet-200 hover:bg-violet-700 transition">
                                <i class="fa-solid fa-plus mr-2"></i>Êñ∞Â¢ûÈ°åÂ∫´
                            </button>
                        </div>
                    </div>

                    <!-- Active Quiz Banner (New Feature) -->
                    <div v-if="activeQuizId" class="bg-gradient-to-r from-emerald-500 to-green-600 text-white p-5 rounded-2xl shadow-lg shadow-green-200 flex flex-col sm:flex-row justify-between items-start sm:items-center animate-fade-in-up border border-green-400 relative overflow-hidden">
                        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
                        <div class="relative z-10 mb-3 sm:mb-0">
                            <p class="text-xs font-bold opacity-90 mb-1 flex items-center uppercase tracking-wider">
                                <span class="relative flex h-2 w-2 mr-2">
                                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span>
                                  <span class="relative inline-flex rounded-full h-2 w-2 bg-white"></span>
                                </span>
                                ÁõÆÂâçÊ≠£Âú®ÈÄ≤Ë°å‰∏≠
                            </p>
                            <h3 class="text-xl font-bold flex items-center gap-2">
                                <i class="fa-solid fa-chalkboard-user"></i>
                                {{ getActiveQuizTitle }}
                            </h3>
                        </div>
                        <button @click="deactivateQuiz" class="relative z-10 bg-white text-green-700 px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-green-50 transition shadow-md flex items-center whitespace-nowrap">
                            <i class="fa-solid fa-stop mr-2"></i> ÁµêÊùüÊ∏¨È©ó
                        </button>
                    </div>

                    <!-- ÂàÜÈ°ûÁØ©ÈÅ∏Âô® -->
                    <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                        <button @click="selectedCategory = 'All'" 
                            class="px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition border"
                            :class="selectedCategory === 'All' ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'">
                            ÂÖ®ÈÉ®
                        </button>
                        <button v-for="cat in uniqueCategories" :key="cat" @click="selectedCategory = cat"
                            class="px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition border"
                            :class="selectedCategory === cat ? 'bg-violet-600 text-white border-violet-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'">
                            {{ cat }}
                        </button>
                    </div>

                    <!-- È°åÂ∫´ÂàóË°® -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="quiz in filteredQuizzes" :key="quiz.id" class="bg-white rounded-2xl p-6 shadow-sm border transition relative overflow-hidden group"
                             :class="{'border-green-400 shadow-lg ring-2 ring-green-100': activeQuizId === quiz.id, 'border-slate-100 hover:shadow-md': activeQuizId !== quiz.id}">
                            
                            <!-- ÈÄ≤Ë°å‰∏≠Ê®ôÁ±§ -->
                            <div v-if="activeQuizId === quiz.id" class="absolute top-0 right-0 bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-bl-xl shadow-sm flex items-center z-10">
                                <span class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></span>
                                ÈÄ≤Ë°å‰∏≠
                            </div>

                            <div class="flex justify-between items-start mb-2">
                                <div class="flex gap-2">
                                    <span class="bg-violet-50 text-violet-600 px-2 py-1 rounded-md text-xs font-bold border border-violet-100">
                                        {{ quiz.category || 'Êú™ÂàÜÈ°û' }}
                                    </span>
                                    <span class="bg-slate-100 text-slate-600 px-2 py-1 rounded-md text-xs font-bold">
                                        {{ quiz.questions.length }} È°å
                                    </span>
                                </div>
                                <div class="flex gap-1">
                                    <button @click="editQuiz(quiz)" class="text-slate-300 hover:text-blue-500 transition p-1" title="Á∑®ËºØÈ°åÂ∫´ÂÖßÂÆπ"><i class="fa-solid fa-pen-to-square"></i></button>
                                    <button @click="deleteQuiz(quiz.id)" class="text-slate-300 hover:text-red-500 transition p-1" title="Âà™Èô§È°åÂ∫´"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                            
                            <h3 class="text-xl font-bold text-slate-800 mb-1 truncate" :title="quiz.title">{{ quiz.title }}</h3>
                            <p class="text-xs text-slate-400 mb-6">Âª∫Á´ãÊñº: {{ formatDate(quiz.createdAt) }}</p>
                            
                            <div class="flex gap-2">
                                <button v-if="activeQuizId === quiz.id" disabled class="flex-1 py-2 bg-green-50 text-green-600 rounded-lg text-sm font-bold cursor-default border border-green-200">
                                    <i class="fa-solid fa-rss mr-1"></i> Â∑≤ÂïüÁî®
                                </button>
                                <button v-else @click="activateQuiz(quiz.id)" class="flex-1 py-2 bg-slate-800 text-white rounded-lg text-sm font-bold hover:bg-slate-900 transition shadow-md">
                                    <i class="fa-solid fa-play mr-1"></i> ÂïüÁî®
                                </button>
                                <button @click="duplicateQuiz(quiz)" class="px-3 py-2 bg-blue-50 text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-100" title="Ë§áË£ΩÈ°åÂ∫´">
                                    <i class="fa-regular fa-clone"></i>
                                </button>
                                <button @click="viewAnalytics(quiz)" class="px-3 py-2 bg-slate-100 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-200" title="Êü•ÁúãÂàÜÊûê">
                                    <i class="fa-solid fa-chart-pie"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Empty State -->
                        <div v-if="filteredQuizzes.length === 0" class="col-span-full py-12 text-center text-slate-400 border-2 border-dashed border-slate-200 rounded-2xl">
                            <i class="fa-solid fa-folder-open text-4xl mb-3 opacity-30"></i>
                            <p>Ê≠§ÂàÜÈ°û‰∏ãÊ≤íÊúâÈ°åÂ∫´</p>
                        </div>
                    </div>

                    <!-- ÂâµÂª∫/Á∑®ËºØÈ°åÂ∫´ Modal -->
                    <div v-if="showCreateQuiz" class="fixed inset-0 z-40 bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto">
                        <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto flex flex-col">
                            <div class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                                <h3 class="text-xl font-bold">{{ editingQuizId ? 'Á∑®ËºØÈ°åÂ∫´' : 'Âª∫Á´ãÊñ∞È°åÂ∫´' }}</h3>
                                <button @click="showCreateQuiz = false" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                            </div>
                            
                            <div class="p-6 space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Ê∏¨È©óÊ®ôÈ°å</label>
                                        <input v-model="newQuiz.title" type="text" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-violet-500" placeholder="‰æãÂ¶ÇÔºöÂúãÊñáÁ¨¨‰∏âË™≤Èö®Â†ÇËÄÉ">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">ÂàÜÈ°û</label>
                                        <input v-model="newQuiz.category" list="category-list" type="text" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-violet-500" placeholder="‰æãÂ¶ÇÔºöÂúãÊñá">
                                        <datalist id="category-list">
                                            <option v-for="cat in uniqueCategories" :key="cat" :value="cat"></option>
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">È°åÂûã</label>
                                        <select v-model="newQuiz.questionType" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-violet-500">
                                            <option value="multiple-choice">‰∏ÄËà¨ÈÅ∏ÊìáÈ°å</option>
                                            <option value="reading-comprehension">Èñ±ËÆÄÊ∏¨È©ó</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Èñ±ËÆÄÊ∏¨È©óË®≠ÂÆö -->
                                <div v-if="newQuiz.questionType === 'reading-comprehension'" class="bg-blue-50 p-6 rounded-xl space-y-4 animate-fade-in">
                                    <div class="flex items-center mb-4">
                                        <i class="fa-solid fa-book-open text-blue-600 mr-3"></i>
                                        <h4 class="font-bold text-blue-800">Èñ±ËÆÄÊ∏¨È©óË®≠ÂÆö</h4>
                                    </div>
                                    
                                    <!-- ÊñáÊú¨‰æÜÊ∫êËàáË™ûË®ÄÈÅ∏Êìá -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 mb-2">ÊñáÊú¨‰æÜÊ∫ê</label>
                                            <div class="space-y-2">
                                                <label class="flex items-center">
                                                    <input type="radio" v-model="readingConfig.textSource" value="paste" class="mr-2">
                                                    <span>Áõ¥Êé•Ë≤º‰∏äÊñáÊú¨</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="radio" v-model="readingConfig.textSource" value="upload" class="mr-2">
                                                    <span>‰∏äÂÇ≥ÊñáÊú¨Ê™îÊ°à</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="radio" v-model="readingConfig.textSource" value="topic" class="mr-2">
                                                    <span>ÊåáÂÆö‰∏ªÈ°åÁî±AIÁîüÊàê</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 mb-2">AIËº∏Âá∫Ë™ûË®Ä</label>
                                            <div class="space-y-2">
                                                <label class="flex items-center">
                                                    <input type="radio" v-model="readingConfig.language" value="ÁπÅ‰∏≠" class="mr-2">
                                                    <span>ÁπÅÈ´î‰∏≠Êñá</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="radio" v-model="readingConfig.language" value="Ëã±Êñá" class="mr-2">
                                                    <span>English (Ëã±Êñá)</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="radio" v-model="readingConfig.language" value="Êó•Êñá" class="mr-2">
                                                    <span>Êó•Êú¨Ë™û (Êó•Êñá)</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="radio" v-model="readingConfig.language" value="ÈüìÊñá" class="mr-2">
                                                    <span>ÌïúÍµ≠Ïñ¥ (ÈüìÊñá)</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Ê†πÊìö‰æÜÊ∫êÈ°ØÁ§∫Â∞çÊáâÊìç‰Ωú -->
                                    <div v-if="readingConfig.textSource === 'topic'" class="mb-3">
                                        <label class="block text-sm font-medium text-slate-700 mb-2">‰∏ªÈ°åÊèèËø∞</label>
                                        <div class="flex gap-2">
                                            <input v-model="readingConfig.topic" type="text" class="flex-1 p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="‰æãÂ¶ÇÔºöÁí∞‰øùË≠∞È°å„ÄÅÁßëÊäÄÁôºÂ±ï„ÄÅÊ≠∑Âè≤‰∫ã‰ª∂...">
                                            <button @click="generatePassageFromTopic" :disabled="!readingConfig.topic.trim() || isGenerating" class="px-4 py-2 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition whitespace-nowrap">
                                                <span v-if="isGenerating"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>ÁîüÊàê‰∏≠...</span>
                                                <span v-else><i class="fa-solid fa-sparkles mr-2"></i>Áî±AIÁîüÊàêÊñáÊú¨</span>
                                            </button>
                                        </div>
                                        <div class="mt-2 inline-flex items-center px-2.5 py-1 bg-green-50 rounded-full">
                                            <i class="fa-solid fa-robot text-green-600 mr-1.5 text-xs"></i>
                                            <span class="text-xs font-medium text-green-700">‰ΩøÁî®Ê®°Âûã: {{ currentModelName }}</span>
                                        </div>
                                    </div>

                                    <div v-if="readingConfig.textSource === 'upload'" class="mb-3">
                                        <label class="block text-sm font-medium text-slate-700 mb-2">‰∏äÂÇ≥ÊñáÊú¨Ê™îÊ°à</label>
                                        <input type="file" @change="handleTextFileUpload" accept=".txt,.doc,.docx" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                                    </div>

                                    <!-- Áµ±‰∏ÄÁöÑÊñáÊú¨Ëº∏ÂÖ•Ê°Ü -->
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Èñ±ËÆÄÊñáÊú¨ÔºàÂèØÁ∑®ËºØÔºâ</label>
                                        <textarea v-model="newQuiz.readingPassage" class="w-full h-40 p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="Ë´ãË≤º‰∏äÊñáÊú¨„ÄÅ‰∏äÂÇ≥Ê™îÊ°àÊàñÁî±AIÁîüÊàêÊñáÊú¨..."></textarea>
                                    </div>
                                    
                                    <!-- PIRLSÈñ±ËÆÄÁêÜËß£ÂõõÂ±§Ê¨°Ë®≠ÂÆö -->
                                    <div class="border-t border-blue-200 pt-4">
                                        <h5 class="font-bold text-slate-700 mb-3">PIRLSÈñ±ËÆÄÁêÜËß£Â±§Ê¨°Ë®≠ÂÆö</h5>
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            <div>
                                                <label class="block text-xs font-medium text-slate-600 mb-1">ÊèêÂèñË®äÊÅØ</label>
                                                <input v-model.number="readingConfig.pirlsLevels.retrieval" type="number" min="0" max="10" class="w-full p-2 border border-slate-200 rounded-lg text-center">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-slate-600 mb-1">Êé®Ë´ñÁêÜËß£</label>
                                                <input v-model.number="readingConfig.pirlsLevels.inference" type="number" min="0" max="10" class="w-full p-2 border border-slate-200 rounded-lg text-center">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-slate-600 mb-1">Ë©ÆÈáãÊï¥Âêà</label>
                                                <input v-model.number="readingConfig.pirlsLevels.interpretation" type="number" min="0" max="10" class="w-full p-2 border border-slate-200 rounded-lg text-center">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-slate-600 mb-1">Ë©ï‰º∞ÈëëË≥û</label>
                                                <input v-model.number="readingConfig.pirlsLevels.evaluation" type="number" min="0" max="10" class="w-full p-2 border border-slate-200 rounded-lg text-center">
                                            </div>
                                        </div>
                                        <p class="text-xs text-slate-500 mt-2">Á∏ΩÈ°åÊï∏Ôºö{{ (readingConfig.pirlsLevels.retrieval || 0) + (readingConfig.pirlsLevels.inference || 0) + (readingConfig.pirlsLevels.interpretation || 0) + (readingConfig.pirlsLevels.evaluation || 0) }} È°å</p>
                                    </div>
                                    
                                    <!-- ÁîüÊàêÊåâÈàï -->
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-end">
                                            <div class="inline-flex items-center px-3 py-1.5 bg-blue-50 rounded-full">
                                                <i class="fa-solid fa-robot text-blue-600 mr-2 text-xs"></i>
                                                <span class="text-xs font-medium text-blue-700">‰ΩøÁî®Ê®°Âûã: {{ currentModelName }}</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-end">
                                            <button @click="generateReadingComprehension" :disabled="!canGenerateReading || isGenerating" class="px-6 py-2 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                                                <span v-if="isGenerating"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>AI ÁîüÊàêÈ°åÁõÆ‰∏≠...</span>
                                                <span v-else><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>ÁîüÊàêÈñ±ËÆÄÊ∏¨È©ó</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabs (Âè™Âú®‰∏ÄËà¨ÈÅ∏ÊìáÈ°åÊôÇÈ°ØÁ§∫) -->
                                <div v-if="newQuiz.questionType === 'multiple-choice'" class="flex border-b border-slate-200">
                                    <button @click="createMode = 'ai'" :class="{'border-violet-600 text-violet-600': createMode === 'ai', 'border-transparent text-slate-500': createMode !== 'ai'}" class="px-6 py-3 border-b-2 font-medium transition">AI Ëá™ÂãïÂá∫È°å</button>
                                    <button @click="createMode = 'manual'" :class="{'border-violet-600 text-violet-600': createMode === 'manual', 'border-transparent text-slate-500': createMode !== 'manual'}" class="px-6 py-3 border-b-2 font-medium transition">ÊâãÂãï/Ë≤º‰∏äÈ°åÂ∫´</button>
                                </div>

                                <!-- AI Mode -->
                                <div v-if="newQuiz.questionType === 'multiple-choice' && createMode === 'ai'" class="space-y-4 animate-fade-in">
                                    <div class="bg-violet-50 p-4 rounded-xl text-sm text-violet-700">
                                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>AI Â∞áËá™ÂãïÂæûÊÇ®Êèê‰æõÁöÑÂÖßÂÆπÊäìÂèñÈáçÈªû‰∏¶ÁîüÊàêÈ°åÁõÆ„ÄÇ
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">‰æÜÊ∫êÂÖßÂÆπ (ÊñáÂ≠ó„ÄÅPDF Êàñ ÂúñÁâá)</label>
                                        <textarea v-model="aiSourceText" class="w-full h-32 p-3 border border-slate-200 rounded-xl mb-2" placeholder="Ë≤º‰∏äË™≤Êñá„ÄÅÊñáÁ´†ÂÖßÂÆπÔºåÊàñ‰ΩøÁî®‰∏ãÊñπÊåâÈàï‰∏äÂÇ≥..."></textarea>
                                        
                                        <div class="flex flex-wrap items-center gap-2">
                                            <!-- ‰∏äÂÇ≥ÂúñÁâá -->
                                            <label class="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg cursor-pointer text-slate-600 text-sm font-medium transition border border-slate-200">
                                                <i class="fa-solid fa-image mr-1"></i> ‰∏äÂÇ≥ÂúñÁâá
                                                <input type="file" accept="image/*" class="hidden" @change="handleImageUpload">
                                            </label>

                                            <!-- ‰∏äÂÇ≥ PDF (Êñ∞Â¢û) -->
                                            <label class="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg cursor-pointer text-slate-600 text-sm font-medium transition border border-slate-200" :class="{'opacity-50 cursor-not-allowed': isPdfLoading}">
                                                <i class="fa-solid fa-file-pdf mr-1 text-red-500"></i> ‰∏äÂÇ≥ PDF ÊñáÊú¨
                                                <input type="file" accept="application/pdf" class="hidden" @change="handlePdfUpload" :disabled="isPdfLoading">
                                            </label>

                                            <!-- ÁãÄÊÖãÈ°ØÁ§∫ -->
                                            <span v-if="aiImageBase64" class="text-xs text-green-600 flex items-center bg-green-50 px-2 py-1 rounded"><i class="fa-solid fa-check mr-1"></i>ÂúñÁâáÂ∑≤ËºâÂÖ•</span>
                                            <span v-if="isPdfLoading" class="text-xs text-violet-600 flex items-center bg-violet-50 px-2 py-1 rounded"><i class="fa-solid fa-circle-notch fa-spin mr-1"></i>PDF Ëß£Êûê‰∏≠...</span>
                                        </div>
                                        <img v-if="aiImageBase64" :src="aiImageBase64" class="mt-2 h-32 object-contain rounded-lg border border-slate-200">
                                    </div>

                                    <div class="grid grid-cols-3 gap-4">
                                        <div>
                                            <label class="text-xs font-bold text-slate-500">Á∞°ÂñÆÈ°åÊï∏</label>
                                            <input v-model.number="aiConfig.easy" type="number" min="0" class="w-full mt-1 p-2 border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="text-xs font-bold text-slate-500">‰∏ÄËà¨È°åÊï∏</label>
                                            <input v-model.number="aiConfig.medium" type="number" min="0" class="w-full mt-1 p-2 border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="text-xs font-bold text-slate-500">Âõ∞Èõ£È°åÊï∏</label>
                                            <input v-model.number="aiConfig.hard" type="number" min="0" class="w-full mt-1 p-2 border rounded-lg">
                                        </div>
                                    </div>

                                    <div class="flex items-center justify-between mb-2">
                                        <div class="inline-flex items-center px-3 py-1.5 bg-violet-50 rounded-full">
                                            <i class="fa-solid fa-robot text-violet-600 mr-2 text-xs"></i>
                                            <span class="text-xs font-medium text-violet-700">‰ΩøÁî®Ê®°Âûã: {{ currentModelName }}</span>
                                        </div>
                                    </div>

                                    <button @click="generateQuestions" :disabled="isGenerating || isPdfLoading" class="w-full py-3 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded-xl font-bold hover:shadow-lg disabled:opacity-50 transition">
                                        <span v-if="isGenerating"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>AI Ê≠£Âú®ÊÄùËÄÉ‰∏≠...</span>
                                        <span v-else><i class="fa-solid fa-robot mr-2"></i>ÈñãÂßã AI Âá∫È°å (Ë¶ÜËìãÁèæÊúâÈ°åÁõÆ)</span>
                                    </button>
                                </div>

                                <!-- Manual Mode -->
                                <div v-if="newQuiz.questionType === 'multiple-choice' && createMode === 'manual'" class="space-y-4 animate-fade-in">
                                    <div class="bg-yellow-50 p-4 rounded-xl text-sm text-yellow-800">
                                        <p class="font-bold mb-1">Ê†ºÂºèË™™Êòé (ÊØèË°å‰∏ÄÈ°åÔºåÁî® Tab Êàñ ÈÄóËôü ÂàÜÈöî)Ôºö</p>
                                        <p>È°åÁõÆ, Á≠îÊ°à(1-4Êàña-d), ÈÅ∏È†ÖA, ÈÅ∏È†ÖB, ÈÅ∏È†ÖC, ÈÅ∏È†ÖD, Ëß£Êûê(ÈÅ∏Â°´)</p>
                                    </div>
                                    <textarea v-model="manualInput" class="w-full h-64 p-3 border border-slate-200 rounded-xl font-mono text-sm leading-relaxed" placeholder="ÁØÑ‰æãÔºö
Âè∞ÁÅ£ÊúÄÈ´òÁöÑÂ±±ÊòØÂì™‰∏ÄÂ∫ßÔºü, 1, ÁéâÂ±±, Èõ™Â±±, ÈòøÈáåÂ±±, ÈôΩÊòéÂ±±, ÁéâÂ±±ÊòØÊù±Âåó‰∫ûÊúÄÈ´òÂ≥∞
1+1Á≠âÊñºÂ§öÂ∞ëÔºü, b, 1, 2, 3, 4, Êï∏Â≠∏Âü∫Êú¨ÈÅãÁÆó"></textarea>
                                    <button @click="parseManualInput" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition">
                                        Ëß£Êûê‰∏¶Âä†ÂÖ•È°åÁõÆ (Append)
                                    </button>
                                </div>

                                <!-- Preview & Edit Area -->
                                <div class="mt-6 border-t border-slate-100 pt-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <h4 class="font-bold text-slate-700">È°åÁõÆÂàóË°® ({{ newQuiz.questions.length }} È°å)</h4>
                                        <button @click="addQuestion" class="text-sm bg-violet-100 text-violet-600 px-3 py-1.5 rounded-lg hover:bg-violet-200 font-bold transition">
                                            <i class="fa-solid fa-plus mr-1"></i> Êñ∞Â¢ûÈ°åÁõÆ
                                        </button>
                                    </div>
                                    
                                    <div class="space-y-4 max-h-80 overflow-y-auto pr-2 pb-2">
                                        <div v-for="(q, idx) in newQuiz.questions" :key="idx" class="p-4 bg-slate-50 rounded-xl border border-slate-100 group hover:border-violet-200 transition">
                                            <div class="flex justify-between items-start">
                                                <span class="font-bold text-slate-800 flex-1">{{ idx + 1 }}. {{ q.title }}</span>
                                                <div class="flex gap-2 ml-4">
                                                    <button @click="editQuestion(idx)" class="text-slate-400 hover:text-blue-500 p-1" title="‰øÆÊîπ"><i class="fa-solid fa-pen"></i></button>
                                                    <button @click="deleteQuestion(idx)" class="text-slate-400 hover:text-red-500 p-1" title="Âà™Èô§"><i class="fa-solid fa-trash"></i></button>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2 mt-2">
                                                <span class="text-xs px-2 py-1 bg-white border rounded text-slate-500 inline-block">{{ q.difficulty || '‰∏ÄËà¨' }}</span>
                                                <span v-if="q.pirlsLevel" class="text-xs px-2 py-1 bg-blue-100 text-blue-700 border border-blue-200 rounded inline-block font-medium">
                                                    <i class="fa-solid fa-layer-group mr-1"></i>{{ getPirlsLevelName(q.pirlsLevel) }}
                                                </span>
                                            </div>
                                            
                                            <div class="grid grid-cols-2 gap-2 mt-2 text-sm text-slate-600 pl-4">
                                                <div v-for="(opt, i) in q.options" :key="i" :class="{'text-green-600 font-bold': (i + 1) == q.answer}">
                                                    {{ String.fromCharCode(65+i) }}. {{ opt }}
                                                </div>
                                            </div>
                                            <p v-if="q.explanation" class="mt-2 text-xs text-slate-400 border-t border-slate-200 pt-1">üí° {{ q.explanation }}</p>
                                        </div>
                                        <div v-if="newQuiz.questions.length === 0" class="text-center text-slate-400 py-8">
                                            Â∞öÊú™Âä†ÂÖ•‰ªª‰ΩïÈ°åÁõÆ
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="p-6 border-t border-slate-100 sticky bottom-0 bg-white flex justify-end gap-3">
                                <button @click="showCreateQuiz = false" class="px-6 py-2 text-slate-500 font-medium hover:bg-slate-50 rounded-xl">ÂèñÊ∂à</button>
                                <button @click="saveQuiz" :disabled="newQuiz.questions.length === 0" class="px-6 py-2 bg-violet-600 text-white font-bold rounded-xl shadow-lg shadow-violet-200 hover:bg-violet-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                    {{ editingQuizId ? 'Êõ¥Êñ∞È°åÂ∫´' : 'ÂÑ≤Â≠òÊñ∞È°åÂ∫´' }}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Single Question Editor Modal -->
                    <div v-if="showQuestionEditor" class="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
                        <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl animate-fade-in-up">
                            <h3 class="text-lg font-bold mb-4">{{ currentEditingQuestionIndex === -1 ? 'Êñ∞Â¢ûÈ°åÁõÆ' : 'Á∑®ËºØÈ°åÁõÆ' }}</h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">È°åÁõÆÊïòËø∞</label>
                                    <textarea v-model="currentEditingQuestion.title" class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-violet-500 h-20"></textarea>
                                </div>
                                
                                <div class="grid grid-cols-1 gap-2">
                                    <div v-for="(opt, i) in currentEditingQuestion.options" :key="i" class="flex items-center gap-2">
                                        <span class="w-6 text-center text-sm font-bold text-slate-500">{{ String.fromCharCode(65+i) }}</span>
                                        <input v-model="currentEditingQuestion.options[i]" type="text" class="flex-1 p-2 border border-slate-200 rounded-lg text-sm" placeholder="ÈÅ∏È†ÖÂÖßÂÆπ">
                                        <input type="radio" :name="'correct-ans'" :value="i+1" v-model="currentEditingQuestion.answer" class="accent-green-500 w-4 h-4 cursor-pointer" title="Ë®≠ÁÇ∫Ê≠£Á¢∫Á≠îÊ°à">
                                    </div>
                                </div>

                                <div class="flex gap-4">
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Èõ£ÊòìÂ∫¶</label>
                                        <select v-model="currentEditingQuestion.difficulty" class="w-full p-2 border border-slate-200 rounded-lg">
                                            <option value="Á∞°ÂñÆ">Á∞°ÂñÆ</option>
                                            <option value="‰∏ÄËà¨">‰∏ÄËà¨</option>
                                            <option value="Âõ∞Èõ£">Âõ∞Èõ£</option>
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Ëß£Êûê (ÈÅ∏Â°´)</label>
                                    <textarea v-model="currentEditingQuestion.explanation" class="w-full p-2 border border-slate-200 rounded-lg h-16 text-sm"></textarea>
                                </div>
                            </div>

                            <div class="mt-6 flex justify-end gap-3">
                                <button @click="showQuestionEditor = false" class="px-4 py-2 text-slate-500 hover:bg-slate-50 rounded-lg font-medium">ÂèñÊ∂à</button>
                                <button @click="saveQuestion" class="px-4 py-2 bg-slate-800 text-white rounded-lg font-bold hover:bg-slate-900">Á¢∫Ë™ç</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analytics Modal -->
                    <div v-if="showAnalytics" class="fixed inset-0 z-40 bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
                        <div class="bg-white rounded-2xl w-full max-w-5xl h-[90vh] flex flex-col p-6">
                            <!-- Header -->
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                <div>
                                    <h3 class="text-2xl font-bold">{{ selectedAnalyticsQuiz.title }} - ÂàÜÊûêÂ†±Âëä</h3>
                                    <p class="text-slate-500">ÂÖ± {{ analyticsData.length }} ‰ΩçÂ≠∏Áîü‰ΩúÁ≠î</p>
                                </div>
                                <div class="flex gap-2">
                                    <button v-if="selectedStudentResult" @click="closeStudentDetails" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition text-sm font-bold">
                                        <i class="fa-solid fa-arrow-left mr-2"></i>ËøîÂõû
                                    </button>
                                    <button v-if="!selectedStudentResult" @click="exportCSV" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm font-bold shadow-md shadow-green-200">
                                        <i class="fa-solid fa-file-csv mr-2"></i>‰∏ãËºâÂ†±Ë°®
                                    </button>
                                    <button @click="showAnalytics = false" class="text-slate-400 hover:text-slate-600 px-2"><i class="fa-solid fa-xmark text-xl"></i></button>
                                </div>
                            </div>

                            <!-- Tabs -->
                            <div v-if="!selectedStudentResult" class="flex border-b border-slate-200 mb-6">
                                <button @click="analyticsTab = 'score'" 
                                    class="px-6 py-3 border-b-2 font-medium transition text-sm sm:text-base"
                                    :class="analyticsTab === 'score' ? 'border-violet-600 text-violet-600' : 'border-transparent text-slate-500 hover:text-slate-700'">
                                    <i class="fa-solid fa-chart-column mr-2"></i>ÊàêÁ∏æÂàÜ‰Ωà & ÂàóË°®
                                </button>
                                <button @click="analyticsTab = 'question'" 
                                    class="px-6 py-3 border-b-2 font-medium transition text-sm sm:text-base"
                                    :class="analyticsTab === 'question' ? 'border-violet-600 text-violet-600' : 'border-transparent text-slate-500 hover:text-slate-700'">
                                    <i class="fa-solid fa-list-check mr-2"></i>Ë©¶È°åÂàÜÊûê
                                </button>
                            </div>
                            
                            <!-- Tab Content: Score Overview -->
                            <div v-if="!selectedStudentResult && analyticsTab === 'score'" class="flex-grow overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">
                                <!-- Chart Area -->
                                <div class="bg-slate-50 p-4 rounded-xl flex flex-col items-center justify-center h-min">
                                    <canvas id="scoreChart"></canvas>
                                </div>
                                <!-- Student List -->
                                <div class="bg-white border border-slate-100 rounded-xl overflow-hidden h-max">
                                    <table class="w-full text-sm text-left">
                                        <thead class="bg-slate-100 text-slate-600 font-bold">
                                            <tr>
                                                <th class="p-3">Â≠∏ÁîüÂßìÂêç</th>
                                                <th class="p-3">ÂæóÂàÜ</th>
                                                <th class="p-3 text-center">Êìç‰Ωú</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="res in analyticsData" :key="res.id" class="border-b border-slate-50 hover:bg-slate-50 transition cursor-pointer" @click="viewStudentDetails(res)">
                                                <td class="p-3 font-medium">{{ res.studentName }}</td>
                                                <td class="p-3 font-bold" :class="getScoreColor(res.score)">{{ res.score }}</td>
                                                <td class="p-3 text-center">
                                                    <button class="text-xs bg-violet-100 text-violet-600 px-2 py-1 rounded hover:bg-violet-200">
                                                        Ë©≥ÊÉÖ
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr v-if="analyticsData.length === 0">
                                                <td colspan="3" class="p-4 text-center text-slate-400">Â∞öÁÑ°Â≠∏Áîü‰ΩúÁ≠îË®òÈåÑ</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Tab Content: Question Analysis -->
                            <div v-if="!selectedStudentResult && analyticsTab === 'question'" class="flex-grow overflow-y-auto space-y-4 animate-fade-in">
                                <div v-for="stat in questionStats" :key="stat.index" class="bg-white border border-slate-200 rounded-xl p-5 hover:shadow-sm transition">
                                    <div class="flex justify-between items-start mb-3">
                                        <h4 class="font-bold text-slate-800 text-lg flex-1 mr-4">
                                            <span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs mr-2">Q{{ stat.index + 1 }}</span>
                                            {{ stat.question.title }}
                                        </h4>
                                        <div class="text-right flex-shrink-0">
                                            <span class="text-xs text-slate-500 block mb-1">Á≠îÂ∞çÁéá</span>
                                            <span class="text-xl font-bold" :class="getScoreColor(stat.rate)">{{ stat.rate }}%</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Progress Bar -->
                                    <div class="w-full bg-slate-100 rounded-full h-2 mb-4 overflow-hidden">
                                        <div class="h-2 rounded-full transition-all duration-1000" 
                                             :class="stat.rate >= 60 ? 'bg-green-500' : 'bg-red-500'"
                                             :style="{ width: stat.rate + '%' }"></div>
                                    </div>

                                    <!-- Details (Expandable) -->
                                    <details class="group">
                                        <summary class="flex items-center text-sm font-medium text-slate-500 cursor-pointer hover:text-violet-600 select-none">
                                            <i class="fa-solid fa-chevron-right text-xs mr-2 transition-transform group-open:rotate-90"></i>
                                            Êü•ÁúãÁ≠îÈåØÂêçÂñÆ ({{ stat.wrongStudents.length }}‰∫∫)
                                        </summary>
                                        <div class="mt-3 pl-6 pt-2 border-t border-slate-100 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                                            <div v-for="ws in stat.wrongStudents" :key="ws.name" class="text-sm bg-red-50 text-red-700 px-3 py-2 rounded-lg flex justify-between items-center">
                                                <span>{{ ws.name }}</span>
                                                <span class="font-bold bg-white px-2 rounded text-xs border border-red-100" v-if="ws.choice">ÈÅ∏‰∫Ü {{ String.fromCharCode(64 + parseInt(ws.choice)) }}</span>
                                                <span class="font-bold bg-white px-2 rounded text-xs border border-red-100" v-else>Êú™‰ΩúÁ≠î</span>
                                            </div>
                                            <div v-if="stat.wrongStudents.length === 0" class="text-sm text-green-600 py-2">
                                                <i class="fa-solid fa-check-circle mr-1"></i> ÂÖ®Áè≠Á≠îÂ∞çÔºåÂ§™Ê£í‰∫ÜÔºÅ
                                            </div>
                                        </div>
                                    </details>
                                </div>
                                <div v-if="questionStats.length === 0" class="text-center p-10 text-slate-400">
                                    Êö´ÁÑ°Ë©¶È°åÊï∏Êìö
                                </div>
                            </div>

                            <!-- Detail View: Specific Student -->
                            <div v-if="selectedStudentResult" class="flex-grow overflow-y-auto animate-fade-in">
                                <div class="bg-slate-50 p-4 rounded-xl mb-6 border border-slate-200 flex justify-between items-center">
                                    <div>
                                        <span class="text-sm text-slate-500">Â≠∏ÁîüÂßìÂêç</span>
                                        <h4 class="text-xl font-bold text-slate-800">{{ selectedStudentResult.studentName }}</h4>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-sm text-slate-500">Ê∏¨È©óÂæóÂàÜ</span>
                                        <div class="text-3xl font-bold" :class="getScoreColor(selectedStudentResult.score)">{{ selectedStudentResult.score }}</div>
                                    </div>
                                </div>

                                <!-- NEW: Reading passage with highlights -->
                                <div v-if="selectedAnalyticsQuiz.questionType === 'reading-comprehension'" class="mb-6">
                                    <h4 class="text-lg font-bold text-slate-700 mb-3 border-l-4 border-blue-500 pl-3">Â≠∏ÁîüÁï´Ë®òÂÖßÂÆπ</h4>
                                    <div 
                                        class="bg-white p-4 rounded-xl border border-slate-200 passage-content prose prose-sm max-w-none text-slate-700 leading-relaxed overflow-y-auto max-h-60 whitespace-pre-wrap"
                                        v-html="teacherHighlightedPassage"
                                    ></div>
                                     <p class="text-xs text-slate-400 mt-2">Ê≠§ËôïÂÉÖÁÇ∫È°ØÁ§∫Â≠∏ÁîüÁï´Ë®òÁµêÊûúÔºåÁÑ°Ê≥ïÁ∑®ËºØ„ÄÇ</p>
                                </div>

                                <h4 class="text-lg font-bold text-slate-700 mb-3 border-l-4 border-violet-500 pl-3">Â≠∏ÁîüÁ≠îÈ°åË©≥ÊÉÖ</h4>
                                <div class="space-y-4">
                                    <div v-for="(q, idx) in selectedAnalyticsQuiz.questions" :key="idx" class="p-4 rounded-xl border bg-white"
                                        :class="selectedStudentResult.answers[idx] == q.answer ? 'border-green-100' : 'border-red-100'">
                                        
                                        <div class="flex gap-3 mb-2">
                                            <div class="mt-1 flex-shrink-0">
                                                <i v-if="selectedStudentResult.answers[idx] == q.answer" class="fa-solid fa-circle-check text-green-500 text-lg"></i>
                                                <i v-else class="fa-solid fa-circle-xmark text-red-500 text-lg"></i>
                                            </div>
                                            <div class="flex-grow">
                                                <h5 class="font-bold text-slate-800 text-base">{{ idx + 1 }}. {{ q.title }}</h5>
                                            </div>
                                        </div>

                                        <div class="ml-8 space-y-1 text-sm">
                                            <div class="flex items-center gap-2">
                                                <span class="text-slate-500 font-medium">Â≠∏ÁîüÂõûÁ≠îÔºö</span>
                                                <span :class="selectedStudentResult.answers[idx] == q.answer ? 'text-green-600 font-bold' : 'text-red-600 font-bold line-through'">
                                                    {{ q.options[selectedStudentResult.answers[idx]-1] || 'Êú™‰ΩúÁ≠î' }}
                                                </span>
                                            </div>
                                            <div v-if="selectedStudentResult.answers[idx] != q.answer" class="flex items-center gap-2">
                                                <span class="text-slate-500 font-medium">Ê≠£Á¢∫Á≠îÊ°àÔºö</span>
                                                <span class="text-green-600 font-bold">
                                                    {{ q.options[q.answer-1] }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Student Login -->
                <div v-else-if="currentView === 'student-login'" class="flex items-center justify-center py-20">
                     <div class="bg-white p-8 rounded-3xl shadow-xl max-w-sm w-full text-center border-t-4 border-sky-500">
                        <div class="mb-6 inline-block p-4 bg-sky-100 text-sky-500 rounded-full text-3xl">
                            <i class="fa-regular fa-id-card"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Ê∫ñÂÇôÊ∏¨È©ó</h3>
                        <p class="text-slate-400 text-sm mb-6">Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÂßìÂêçÔºåÁ≥ªÁµ±Â∞áËá™ÂãïËºâÂÖ•ËÄÅÂ∏´ÂïüÁî®ÁöÑÊ∏¨È©ó</p>
                        
                        <input type="text" v-model="studentName" placeholder="ÁéãÂ∞èÊòé" 
                            class="w-full p-3 border border-slate-200 rounded-xl mb-4 focus:ring-2 focus:ring-sky-500 outline-none text-center">
                        
                        <div v-if="activeQuizId" class="mb-4 text-center">
                            <span class="text-xs font-bold text-green-600 bg-green-50 px-3 py-1 rounded-full animate-pulse">
                                <i class="fa-solid fa-wifi mr-1"></i> Â∑≤ÂÅµÊ∏¨Âà∞ÈÄ≤Ë°å‰∏≠ÁöÑÊ∏¨È©ó
                            </span>
                        </div>
                        <div v-else class="mb-4 text-center">
                            <span class="text-xs font-bold text-slate-400 bg-slate-100 px-3 py-1 rounded-full">
                                <i class="fa-solid fa-spinner fa-spin mr-1"></i> Á≠âÂæÖËÄÅÂ∏´ÂïüÁî®Ê∏¨È©ó...
                            </span>
                        </div>

                        <button @click="startQuiz" :disabled="!studentName" class="w-full py-3 bg-sky-500 text-white rounded-xl font-bold hover:bg-sky-600 transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-sky-200">
                            ÈÄ≤ÂÖ•‰ΩúÁ≠î
                        </button>
                        <button @click="goToView('landing')" class="mt-4 text-slate-400 text-sm hover:text-slate-600">ËøîÂõûÈ¶ñÈ†Å</button>
                    </div>
                </div>

                <!-- VIEW: Quiz Taking -->
                <div v-else-if="currentView === 'quiz'" :class="activeQuiz.questionType === 'reading-comprehension' ? 'max-w-7xl mx-auto w-full' : 'max-w-2xl mx-auto w-full'">
                    <!-- Header (Same for both types) -->
                    <div class="mb-6 flex justify-between items-center">
                        <span class="text-slate-500 font-medium">ËÄÉÁîüÔºö{{ studentName }}</span>
                        <div class="text-sky-600 font-bold bg-sky-50 px-3 py-1 rounded-lg">
                            Á¨¨ {{ currentQuestionIndex + 1 }} / {{ activeQuiz.questions.length }} È°å
                        </div>
                    </div>

                    <!-- Progress Bar (Same for both types) -->
                    <div class="w-full bg-slate-200 rounded-full h-2 mb-8">
                        <div class="bg-sky-500 h-2 rounded-full transition-all duration-500" :style="{ width: progressPercent + '%' }"></div>
                    </div>

                    <!-- Reading Comprehension Layout -->
                    <div v-if="activeQuiz.questionType === 'reading-comprehension'" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Left Column: Reading Passage with Highlighter -->
                        <div class="bg-white p-6 rounded-3xl shadow-lg border border-slate-100 relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-2 h-full bg-blue-500"></div>
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <i class="fa-solid fa-book-open text-blue-600 mr-3"></i>
                                    <h3 class="text-lg font-bold text-slate-800">Èñ±ËÆÄÊñáÊú¨</h3>
                                </div>
                                <!-- New Highlighter Toolbar -->
                                <div class="flex items-center gap-2 bg-slate-100 p-1.5 rounded-xl">
                                    <button @mousedown.prevent="applyHighlight('yellow')" @touchstart.prevent="applyHighlight('yellow')" class="w-8 h-8 bg-yellow-300 rounded-lg hover:scale-110 transition shadow-sm border-2 border-transparent focus:ring-2 focus:ring-yellow-500" title="ÈªÉËâ≤Ëû¢ÂÖâÁ≠Ü"></button>
                                    <button @mousedown.prevent="applyHighlight('green')" @touchstart.prevent="applyHighlight('green')" class="w-8 h-8 bg-green-300 rounded-lg hover:scale-110 transition shadow-sm border-2 border-transparent focus:ring-2 focus:ring-green-500" title="Á∂†Ëâ≤Ëû¢ÂÖâÁ≠Ü"></button>
                                    <button @mousedown.prevent="applyHighlight('pink')" @touchstart.prevent="applyHighlight('pink')" class="w-8 h-8 bg-pink-300 rounded-lg hover:scale-110 transition shadow-sm border-2 border-transparent focus:ring-2 focus:ring-pink-500" title="Á≤âËâ≤Ëû¢ÂÖâÁ≠Ü"></button>
                                </div>
                            </div>

                            <!-- Text Content -->
                            <div 
                                ref="passageContainer"
                                class="passage-content prose prose-sm max-w-none text-slate-700 leading-relaxed overflow-y-auto max-h-[26rem] mt-4 p-1 whitespace-pre-wrap select-text"
                                v-html="highlightedPassage"
                                @click="handlePassageClick"
                            ></div>
                        </div>

                        <!-- Right Column: Question -->
                        <div class="bg-white p-6 rounded-3xl shadow-lg border border-slate-100 relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-2 h-full bg-sky-500"></div>
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-slate-800">È°åÁõÆ</h3>
                                <span v-if="activeQuiz.questions[currentQuestionIndex].pirlsLevel" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium">
                                    {{ getPirlsLevelName(activeQuiz.questions[currentQuestionIndex].pirlsLevel) }}
                                </span>
                            </div>
                            
                            <h4 class="text-xl font-bold text-slate-800 mb-6 leading-relaxed">
                                {{ activeQuiz.questions[currentQuestionIndex].title }}
                            </h4>

                            <div class="space-y-3">
                                <button v-for="(opt, idx) in activeQuiz.questions[currentQuestionIndex].options" :key="idx"
                                    @click="selectAnswer(idx + 1)"
                                    :class="{'bg-sky-500 text-white border-sky-500': currentAnswer === (idx + 1), 'bg-white text-slate-700 border-slate-200 hover:border-sky-300 hover:bg-sky-50': currentAnswer !== (idx + 1)}"
                                    class="w-full text-left p-4 rounded-xl border-2 transition-all duration-200 font-medium flex items-center group">
                                    <span class="w-8 h-8 rounded-full border-2 flex items-center justify-center mr-4 text-sm font-bold"
                                        :class="{'border-white text-white': currentAnswer === (idx + 1), 'border-slate-300 text-slate-400 group-hover:border-sky-400 group-hover:text-sky-400': currentAnswer !== (idx + 1)}">
                                        {{ String.fromCharCode(65+idx) }}
                                    </span>
                                    {{ opt }}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Regular Multiple Choice Layout -->
                    <div v-else class="bg-white p-6 sm:p-10 rounded-3xl shadow-lg border border-slate-100 mb-8 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-2 h-full bg-sky-500"></div>
                        <h3 class="text-xl sm:text-2xl font-bold text-slate-800 mb-8 leading-relaxed">
                            {{ activeQuiz.questions[currentQuestionIndex].title }}
                        </h3>

                        <div class="space-y-3">
                            <button v-for="(opt, idx) in activeQuiz.questions[currentQuestionIndex].options" :key="idx"
                                @click="selectAnswer(idx + 1)"
                                :class="{'bg-sky-500 text-white border-sky-500': currentAnswer === (idx + 1), 'bg-white text-slate-700 border-slate-200 hover:border-sky-300 hover:bg-sky-50': currentAnswer !== (idx + 1)}"
                                class="w-full text-left p-4 rounded-xl border-2 transition-all duration-200 font-medium flex items-center group">
                                <span class="w-8 h-8 rounded-full border-2 flex items-center justify-center mr-4 text-sm font-bold"
                                    :class="{'border-white text-white': currentAnswer === (idx + 1), 'border-slate-300 text-slate-400 group-hover:border-sky-400 group-hover:text-sky-400': currentAnswer !== (idx + 1)}">
                                    {{ String.fromCharCode(65+idx) }}
                                </span>
                                {{ opt }}
                            </button>
                        </div>
                    </div>

                    <!-- Navigation Buttons (Same for both types) -->
                    <div class="flex justify-between">
                        <button @click="prevQuestion" :disabled="currentQuestionIndex === 0" class="px-6 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-200 disabled:opacity-0 transition">‰∏ä‰∏ÄÈ°å</button>
                        
                        <button v-if="currentQuestionIndex < activeQuiz.questions.length - 1" @click="nextQuestion" class="px-8 py-3 bg-sky-500 text-white rounded-xl font-bold shadow-lg shadow-sky-200 hover:bg-sky-600 transition">
                            ‰∏ã‰∏ÄÈ°å <i class="fa-solid fa-arrow-right ml-2"></i>
                        </button>
                        <button v-else @click="submitQuiz" class="px-8 py-3 bg-green-500 text-white rounded-xl font-bold shadow-lg shadow-green-200 hover:bg-green-600 transition">
                            Êèê‰∫§Ë©¶Âç∑ <i class="fa-solid fa-check ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- VIEW: Quiz Result -->
                <div v-else-if="currentView === 'result'" class="max-w-3xl mx-auto w-full pb-10">
                    <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100 mb-8">
                        <div class="bg-slate-800 text-white p-8 text-center relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-r from-violet-600 to-indigo-600 opacity-90"></div>
                            <div class="relative z-10">
                                <p class="text-indigo-200 mb-2">{{ activeQuiz.title }}</p>
                                <h2 class="text-5xl font-bold mb-2">{{ score }} <span class="text-2xl font-normal opacity-70">ÂàÜ</span></h2>
                                <p class="text-indigo-100">ÂÅöÁöÑÂ•ΩÔºå{{ studentName }}ÔºÅ</p>
                            </div>
                        </div>
                        
                        <div class="p-8">
                            <h3 class="font-bold text-slate-700 mb-6 text-lg border-l-4 border-indigo-500 pl-3">Ë©≥Á¥∞Ëß£Êûê</h3>
                            <div class="space-y-6">
                                <div v-for="(q, idx) in activeQuiz.questions" :key="idx" class="p-5 rounded-2xl border"
                                    :class="studentAnswers[idx] == q.answer ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'">
                                    <div class="flex gap-3 mb-3">
                                        <div class="mt-1">
                                            <i v-if="studentAnswers[idx] == q.answer" class="fa-solid fa-circle-check text-green-500 text-xl"></i>
                                            <i v-else class="fa-solid fa-circle-xmark text-red-500 text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-slate-800 text-lg">{{ idx + 1 }}. {{ q.title }}</h4>
                                        </div>
                                    </div>
                                    
                                    <div class="ml-8 space-y-2 text-sm">
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-slate-500">ÊÇ®ÁöÑÁ≠îÊ°àÔºö</span>
                                            <span :class="studentAnswers[idx] == q.answer ? 'text-green-700 font-bold' : 'text-red-700 font-bold line-through'">
                                                {{ q.options[studentAnswers[idx]-1] }}
                                            </span>
                                        </div>
                                        <div v-if="studentAnswers[idx] != q.answer" class="flex items-center gap-2">
                                            <span class="font-bold text-slate-500">Ê≠£Á¢∫Á≠îÊ°àÔºö</span>
                                            <span class="text-green-700 font-bold">
                                                {{ q.options[q.answer-1] }}
                                            </span>
                                        </div>
                                        <div class="mt-3 p-3 bg-white/60 rounded-lg text-slate-600 text-sm">
                                            <i class="fa-regular fa-lightbulb mr-1 text-yellow-500"></i>
                                            {{ q.explanation || 'ÁÑ°Ëß£Êûê' }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 bg-slate-50 border-t border-slate-100 text-center">
                            <button @click="goToView('landing')" class="px-8 py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition">
                                ËøîÂõûÈ¶ñÈ†Å
                            </button>
                        </div>
                    </div>
                </div>

            </transition>
        </main>
        
        <!-- Footer -->
        <footer class="bg-white/80 backdrop-blur-md border-t border-slate-200 py-4 text-center text-sm text-slate-500">
            Made by <a href="https://kentxchang.blogspot.com/" target="_blank" class="text-violet-600 hover:underline font-bold">ÈòøÂâõËÄÅÂ∏´ V1.1</a>
        </footer>
    </div>

    <!-- Settings Modal -->
    <div v-if="showSettingsModal" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-gear text-slate-400"></i> Á≥ªÁµ±Ë®≠ÂÆö
                </h3>
                <button @click="showSettingsModal = false" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-8">
                <!-- ÂçÄÂ°ä 1: Ë≥áÊñôÂ∫´ÈÄ£Á∑öË®≠ÂÆö -->
                <div>
                    <h4 class="text-sm font-bold text-slate-500 mb-4 uppercase tracking-wider border-l-4 border-violet-500 pl-2">Ë≥áÊñôÂ∫´ÈÄ£Êé•</h4>
                    
                    <!-- Ëã•Êú™Ë®≠ÂÆöÊàñËôïÊñºÁ∑®ËºØÊ®°ÂºèÔºåÈ°ØÁ§∫Ëº∏ÂÖ•Ê°Ü -->
                    <div v-if="!isConfigured || showConfigEdit" class="space-y-4">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm text-slate-600 relative">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-slate-800 flex items-center"><i class="fa-solid fa-circle-info mr-2 text-violet-500"></i> Ë®≠ÂÆöÊñπÂºèË™™Êòé</h4>
                                <button @click="showTutorialModal = true" class="text-xs bg-violet-600 text-white px-3 py-1.5 rounded-lg hover:bg-violet-700 transition shadow-md shadow-violet-200 flex items-center">
                                    <i class="fa-solid fa-book-open mr-1.5"></i>Êü•ÁúãÂúñÊñáÊïôÂ≠∏
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <p class="font-bold text-slate-700 mb-1">ÊñπÂºè‰∏ÄÔºöÊú¨Ê©üÊö´Â≠ò (ÈÅ©ÂêàÊ∏¨Ë©¶)</p>
                                    <p class="text-xs">Â∞á Config Ë≤ºÂú®‰∏ãÊñπÔºåË®≠ÂÆöÂÉÖÂ≠òÂú®Ê≠§ÁÄèË¶ΩÂô®„ÄÇËã•Ê∏ÖÈô§Âø´ÂèñÈúÄÈáçÊñ∞Ëº∏ÂÖ•„ÄÇ</p>
                                </div>
                                <div>
                                    <p class="font-bold text-slate-700 mb-1">ÊñπÂºè‰∫åÔºöÊ∞∏‰πÖÂØ´ÂÖ• (ÈÅ©ÂêàÁôºÂ∏É)</p>
                                    <p class="text-xs">Áõ¥Êé•Á∑®ËºØ <code>index.html</code> ÂéüÂßãÁ¢ºÔºåÂ∞áÂÖßÂÆπÂ°´ÂÖ• <code>manualConfig</code> ËÆäÊï∏„ÄÇÂ≠∏ÁîüÈñãÂïüÁ∂≤È†ÅÂç≥ÂèØÁõ¥Êé•‰ΩøÁî®ÔºåÁÑ°ÈúÄ‰ªª‰ΩïË®≠ÂÆö„ÄÇ</p>
                                </div>
                            </div>
                        </div>
                        <textarea v-model="configInput" placeholder='const firebaseConfig = {&#10;  apiKey: "AIza...",&#10;  authDomain: "...",&#10;  ...&#10;};' 
                            class="w-full h-32 p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-violet-500 font-mono text-sm bg-slate-50"></textarea>
                        
                        <button @click="parseAndSaveConfig" class="w-full py-3 bg-violet-600 hover:bg-violet-700 text-white rounded-xl font-bold shadow-lg shadow-violet-200 transition">
                            ÂÑ≤Â≠ò‰∏¶ÈÄ£Á∑ö
                        </button>
                        <button v-if="isConfigured" @click="showConfigEdit = false" class="w-full py-2 text-slate-400 text-sm hover:text-slate-600">ÂèñÊ∂àÁ∑®ËºØ</button>
                    </div>

                    <!-- Ëã•Â∑≤Ë®≠ÂÆöÔºåÈ°ØÁ§∫ÁãÄÊÖã -->
                    <div v-else class="bg-green-50 p-4 rounded-xl border border-green-100 flex justify-between items-center">
                        <div class="flex items-center text-green-700 font-bold">
                            <i class="fa-solid fa-check-circle text-xl mr-2"></i>
                            Â∑≤ÈÄ£Êé• Firebase Ë≥áÊñôÂ∫´
                        </div>
                        <button @click="showConfigEdit = true" class="text-sm text-slate-500 underline hover:text-violet-600">ÈáçÊñ∞Ë®≠ÂÆö</button>
                    </div>
                </div>

                <!-- ÂçÄÂ°ä 1.5: AI API Ë®≠ÂÆö -->
                <div>
                    <h4 class="text-sm font-bold text-slate-500 mb-4 uppercase tracking-wider border-l-4 border-blue-500 pl-2">AI API Ë®≠ÂÆö</h4>
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-3">
                        <div class="text-xs text-slate-500 bg-blue-100 p-3 rounded-lg space-y-2">
                            <p class="font-bold text-slate-600">Â¶Ç‰ΩïÂèñÂæóÂèäË®≠ÂÆö API Key:</p>
                            <p><i class="fa-solid fa-lightbulb mr-1 text-yellow-500"></i> ÊÇ®ÂèØ‰ª•ÈÄèÈÅé Google AI Studio ÂèñÂæóÂÖçË≤ªÁöÑ Gemini API Key„ÄÇ</p>
                            <p><i class="fa-solid fa-link mr-1"></i> <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline font-bold">ÈªûÊ≠§ÂâçÂæÄ Google AI Studio Áî≥Ë´ã API Key</a></p>
                            <p><i class="fa-solid fa-gear mr-1"></i> Áî≥Ë´ãÂæåÔºåÂ∞á API Key Ë≤ºÂà∞‰∏ãÊñπÁöÑËº∏ÂÖ•Ê°ÜÂç≥ÂèØËá™ÂãïÂÑ≤Â≠ò„ÄÇ</p>
                        </div>
                        <div class="relative">
                            <input type="text" v-model="customApiKey" placeholder="Âú®Ê≠§Ë≤º‰∏äÊÇ®ÁöÑ Gemini API Key"
                                class="w-full p-2 text-sm border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pr-16">
                            <transition name="fade">
                                <span v-if="isApiKeySaved" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-green-600 font-bold flex items-center pointer-events-none">
                                    <i class="fa-solid fa-check mr-1.5"></i>Â∑≤ÂÑ≤Â≠ò
                                </span>
                            </transition>
                        </div>

                        <!-- Model Selection -->
                        <div v-if="customApiKey" class="mt-3">
                            <label class="block text-xs font-bold text-slate-600 mb-2">
                                <i class="fa-solid fa-robot mr-1"></i>ÈÅ∏Êìá AI Ê®°Âûã
                            </label>
                            <select v-model="selectedModel" class="w-full p-2 text-sm border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="gemini-2.5-flash-preview-09-2025">Gemini 2.5 Flash (ÁõÆÂâç‰ΩøÁî®)</option>
                                <option value="gemma-3-27b-it">Gemma 3 27B IT</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1.5">
                                <i class="fa-solid fa-info-circle mr-1"></i>‰∏çÂêåÊ®°ÂûãÊúâ‰∏çÂêåÁöÑÁâπÊÄßÂíåÊïàËÉΩÔºåÂèØ‰æùÈúÄÊ±ÇÂàáÊèõ
                            </p>
                        </div>
                    </div>
                </div>

                <!-- ÂçÄÂ°ä 2: ÂàÜ‰∫´ (ÂÉÖÂú®Â∑≤Ë®≠ÂÆöÊôÇÈ°ØÁ§∫) -->
                <div v-if="isConfigured">
                    <h4 class="text-sm font-bold text-slate-500 mb-4 uppercase tracking-wider border-l-4 border-sky-500 pl-2">ÂàÜ‰∫´ÊáâÁî®Á®ãÂºè</h4>
                    <div class="space-y-4">
                        <!-- ÊïôÂ∏´Áî® -->
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                             <p class="font-bold text-slate-700 mb-2">ÊïôÂ∏´Áî®ÂàÜ‰∫´ (ÂÆåÊï¥ÂäüËÉΩ)</p>
                             <div class="flex flex-col sm:flex-row gap-6 items-center">
                                <div class="bg-white p-2 rounded-lg border shadow-sm cursor-pointer hover:shadow-lg hover:ring-2 hover:ring-sky-500 transition" @click="openQrModal('teacher')">
                                    <div id="qrcode"></div>
                                </div>
                                <div class="flex-1 w-full">
                                    <p class="text-xs text-slate-500 mb-2">Ê≠§ÈÄ£ÁµêÂåÖÂê´Ë®≠ÂÆöÊ™îÔºå‰æõÂÖ∂‰ªñÊïôÂ∏´ÊàñÊÇ®Ëá™Â∑±Âú®ÂÖ∂‰ªñË£ùÁΩÆ‰∏ä‰ΩøÁî®„ÄÇ</p>
                                    <div class="flex gap-2">
                                        <input type="text" :value="shareUrl" readonly class="flex-1 p-2 text-xs border rounded bg-white text-slate-500">
                                        <button @click="copyShareUrl('teacher')" class="px-3 py-2 bg-slate-200 rounded hover:bg-slate-300 text-slate-600 text-xs font-bold whitespace-nowrap">Ë§áË£Ω</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Â≠∏ÁîüÁî® -->
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <p class="font-bold text-blue-800 mb-2">Â≠∏ÁîüÂ∞àÁî®ÂàÜ‰∫´ (Á∞°Âåñ‰ªãÈù¢)</p>
                             <div class="flex flex-col sm:flex-row gap-6 items-center">
                                <div class="bg-white p-2 rounded-lg border shadow-sm cursor-pointer hover:shadow-lg hover:ring-2 hover:ring-blue-500 transition" @click="openQrModal('student')">
                                    <div id="studentQrcode"></div>
                                </div>
                                <div class="flex-1 w-full">
                                    <p class="text-xs text-slate-500 mb-2">Â≠∏ÁîüÂ∞áÂè™ËÉΩÁúãÂà∞Â≠∏ÁîüÁôªÂÖ•Áï´Èù¢ÔºåÁÑ°Ê≥ïÈÄ≤ÂÖ•ÊïôÂ∏´ÂæåÂè∞ÊàñÊõ¥ÊîπË®≠ÂÆö„ÄÇ</p>
                                    <div class="flex gap-2">
                                        <input type="text" :value="studentShareUrl" readonly class="flex-1 p-2 text-xs border rounded bg-white text-slate-500">
                                        <button @click="copyShareUrl('student')" class="px-3 py-2 bg-blue-200 rounded hover:bg-blue-300 text-blue-800 text-xs font-bold whitespace-nowrap">Ë§áË£Ω</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÂçÄÂ°ä 2.5: Êõ¥Êñ∞Êó•Ë™å -->
                <div class="mb-6">
                    <details>
                        <summary class="text-sm font-bold text-slate-500 uppercase tracking-wider cursor-pointer border-l-4 border-violet-300 pl-2 select-none hover:text-violet-600 transition">
                            <i class="fa-solid fa-clock-rotate-left mr-1"></i> Êõ¥Êñ∞Êó•Ë™å
                        </summary>
                        <div class="mt-3 space-y-2 max-h-48 overflow-y-auto pr-2">
                            <div v-for="log in updateLog" :key="log.date + log.desc" class="text-xs p-2 bg-slate-50 rounded-lg border border-slate-100">
                                <span class="font-bold text-slate-700">{{ log.date }}</span>: {{ log.desc }}
                            </div>
                        </div>
                    </details>
                </div>

                <!-- ÂçÄÂ°ä 3: ÈáçÁΩÆ -->
                <div>
                    <h4 class="text-sm font-bold text-slate-500 mb-4 uppercase tracking-wider border-l-4 border-red-500 pl-2">Âç±Èö™ÂçÄÂüü</h4>
                    <button @click="resetConfig" class="w-full py-3 border border-red-200 text-red-600 rounded-xl text-sm hover:bg-red-50 font-bold transition">
                        <i class="fa-solid fa-trash-can mr-2"></i>Ê∏ÖÈô§ÊâÄÊúâË®≠ÂÆö‰∏¶ÁôªÂá∫
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tutorial Modal (Ë©≥Á¥∞ÊïôÂ≠∏ÂúñÂ±§) -->
    <div v-if="showTutorialModal" class="fixed inset-0 z-[60] bg-slate-900/95 backdrop-blur flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-4xl h-[90vh] flex flex-col shadow-2xl relative animate-fade-in-up">
            <!-- Header -->
            <div class="p-6 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center text-xl">
                        <i class="fa-brands fa-google-fire"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-800">Firebase Ë®≠ÂÆöË©≥Á¥∞ÊïôÂ≠∏</h3>
                        <p class="text-xs text-slate-500">Ë´ã‰æùÁÖßÊ≠•È©üÂÆåÊàêÂ∞àÊ°àÂª∫ÁΩÆ</p>
                    </div>
                </div>
                <button @click="showTutorialModal = false" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-200 hover:bg-slate-300 text-slate-600 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6 space-y-8 bg-white">
                <!-- Step 1 -->
                <section class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-violet-100 text-violet-600 rounded-full flex items-center justify-center font-bold">1</div>
                    <div>
                        <h4 class="text-lg font-bold text-slate-800 mb-2">Âª∫Á´ãÂ∞àÊ°à</h4>
                        <p class="text-slate-600 mb-2 text-sm">ÂâçÂæÄ <a href="https://console.firebase.google.com" target="_blank" class="text-blue-500 underline font-medium">Firebase Console</a>ÔºåÈªûÊìä„ÄåÊñ∞Â¢ûÂ∞àÊ°à (Create a project)„ÄçÔºåËº∏ÂÖ•Â∞àÊ°àÂêçÁ®±‰∏¶ÂÆåÊàêÂª∫Á´ã„ÄÇ</p>
                    </div>
                </section>
                
                <!-- Step 2 -->
                <section class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-violet-100 text-violet-600 rounded-full flex items-center justify-center font-bold">2</div>
                    <div>
                        <h4 class="text-lg font-bold text-slate-800 mb-2">Êñ∞Â¢û Web ÊáâÁî®Á®ãÂºè & ÂèñÂæó Config</h4>
                        <p class="text-slate-600 mb-2 text-sm">ÈÄ≤ÂÖ•Â∞àÊ°àÂæåÔºåÈªûÊìäÈ¶ñÈ†Å‰∏äÊñπÁöÑ Web ÂúñÁ§∫ ( <code>&lt;/&gt;</code> )„ÄÇ</p>
                        <ul class="list-disc list-inside text-slate-500 ml-1 space-y-1 text-sm bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <li>Ëº∏ÂÖ• App Êö±Á®± (‰æãÂ¶Ç: Quiz App)„ÄÇ</li>
                            <li>ÈªûÊìä„ÄåË®ªÂÜäÊáâÁî®Á®ãÂºè (Register app)„Äç„ÄÇ</li>
                            <li><strong class="text-violet-600">ÈóúÈçµÊ≠•È©üÔºö</strong>Ë§áË£ΩÂá∫ÁèæÁöÑ <code>const firebaseConfig = { ... }</code> Á®ãÂºèÁ¢ºÂçÄÂ°ä„ÄÇ</li>
                        </ul>
                    </div>
                </section>

                <!-- Step 2.5 (New) -->
                <section class="flex gap-4 bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                    <div class="flex-shrink-0 w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold text-lg"><i class="fa-solid fa-code"></i></div>
                    <div>
                        <h4 class="text-lg font-bold text-slate-800 mb-2">ÈÄ≤ÈöéÔºöÂ¶Ç‰ΩïÂØ´Ê≠ªË®≠ÂÆö (Hardcode)</h4>
                        <p class="text-slate-600 mb-2 text-sm">Ëã•ÊÇ®Â∏åÊúõÂ≠∏ÁîüÊâìÈñãÁ∂≤È†ÅÂç≥ÂèØÁõ¥Êé•‰ΩøÁî®ÔºåÁÑ°ÈúÄÊéÉÊèè QR Code ÊàñËº∏ÂÖ•Ë®≠ÂÆöÔºåË´ãÂü∑Ë°åÊ≠§Ê≠•È©üÔºö</p>
                        <ol class="list-decimal list-inside text-slate-600 text-sm space-y-2">
                            <li>‰ΩøÁî®ÊñáÂ≠óÁ∑®ËºØÂô® (Â¶Ç Notepad, VS Code) ÈñãÂïü <code>index.html</code> Ê™îÊ°à„ÄÇ</li>
                            <li>ÊêúÂ∞ãÈóúÈçµÂ≠ó <code>const manualConfig = {</code>„ÄÇ</li>
                            <li>Â∞áÂâõÂâõË§áË£ΩÁöÑ <code>apiKey</code> Á≠âÂÖßÂÆπÔºåË≤ºÂÖ•Ë©≤Áâ©‰ª∂ÁöÑÂ§ßÊã¨Ëôü‰∏≠„ÄÇ</li>
                            <li>ÂÑ≤Â≠òÊ™îÊ°àÔºåÂ∞áÊ≠§ HTML Ê™îÊ°àÂÇ≥ÈÄÅÁµ¶Â≠∏ÁîüÊàñÈÉ®ÁΩ≤Âà∞Á∂≤Á´ôÂç≥ÂèØ„ÄÇ</li>
                        </ol>
                    </div>
                </section>

                <!-- Step 3 -->
                <section class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-violet-100 text-violet-600 rounded-full flex items-center justify-center font-bold">3</div>
                    <div>
                        <h4 class="text-lg font-bold text-slate-800 mb-2">ÈñãÂïü Authentication (È©óË≠â)</h4>
                        <p class="text-slate-600 mb-2 text-sm">Âú®Â∑¶ÂÅ¥ÈÅ∏ÂñÆÈªûÊìä„ÄåÂª∫ÁΩÆ (Build)„Äç>„ÄåAuthentication„Äç„ÄÇ</p>
                        <ul class="list-disc list-inside text-slate-500 ml-1 space-y-1 text-sm bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <li>ÈªûÊìä„ÄåÈñãÂßã‰ΩøÁî® (Get started)„Äç„ÄÇ</li>
                            <li>ÂàáÊèõÂà∞„ÄåSign-in method„ÄçÈ†ÅÁ±§„ÄÇ</li>
                            <li>ÈÅ∏Êìá„ÄåÂåøÂêç (Anonymous)„ÄçÔºåÂ∞áÈñãÈóú <strong class="text-green-600">ÂïüÁî®</strong> ‰∏¶ÂÑ≤Â≠ò„ÄÇ</li>
                        </ul>
                    </div>
                </section>

                <!-- Step 4 -->
                <section class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-violet-100 text-violet-600 rounded-full flex items-center justify-center font-bold">4</div>
                    <div>
                        <h4 class="text-lg font-bold text-slate-800 mb-2">Âª∫Á´ã Firestore Ë≥áÊñôÂ∫´</h4>
                        <p class="text-slate-600 mb-2 text-sm">Âú®Â∑¶ÂÅ¥ÈÅ∏ÂñÆÈªûÊìä„ÄåÂª∫ÁΩÆ (Build)„Äç>„ÄåFirestore Database„Äç„ÄÇ</p>
                        <ul class="list-disc list-inside text-slate-500 ml-1 space-y-1 text-sm bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <li>ÈªûÊìä„ÄåÂª∫Á´ãË≥áÊñôÂ∫´ (Create database)„Äç„ÄÇ</li>
                            <li>ÈÅ∏Êìá„Äå‰ª•Ê∏¨Ë©¶Ê®°ÂºèÂïüÂãï (Start in test mode)„Äç(Êñπ‰æøÂø´ÈÄüÊ∏¨Ë©¶)„ÄÇ</li>
                            <li>ÈÅ∏Êìá‰ΩçÁΩÆ (Location)ÔºåÈÄöÂ∏∏ÈÅ∏È†êË®≠Âç≥ÂèØÔºåÁ≠âÂæÖÂª∫Á´ãÂÆåÊàê„ÄÇ</li>
                        </ul>
                    </div>
                </section>

                <!-- Step 5 -->
                <section class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-violet-100 text-violet-600 rounded-full flex items-center justify-center font-bold">5</div>
                    <div class="w-full">
                        <h4 class="text-lg font-bold text-slate-800 mb-2">Ë®≠ÂÆöÂÆâÂÖ®ÊÄßË¶èÂâá (Âª∫Ë≠∞)</h4>
                        <p class="text-slate-600 mb-2 text-sm">Âú® Firestore È†ÅÈù¢‰∏äÊñπÂàáÊèõÂà∞„ÄåË¶èÂâá (Rules)„ÄçÈ†ÅÁ±§ÔºåË≤º‰∏ä‰ª•‰∏ãË¶èÂâá‰ª•Á¢∫‰øùÊ¨äÈôêÊ≠£Á¢∫Ôºö</p>
                        <div class="bg-slate-800 text-slate-200 p-4 rounded-lg font-mono text-xs overflow-x-auto relative group mt-2 border border-slate-700 shadow-inner">
                            <pre>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /config/quizStatus {
      allow read, write: if true;
    }
    match /quizzes/{quizId} {
      allow read: if true;
      allow create, delete: if request.auth != null;
    }
    match /results/{resultId} {
      allow create, read: if true;
    }
  }
}</pre>
                            <button @click="copyRules" class="absolute top-2 right-2 bg-white/10 hover:bg-white/20 text-white px-2 py-1 rounded text-xs transition">Ë§áË£Ω</button>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- Footer -->
            <div class="p-4 border-t bg-slate-50 text-center rounded-b-2xl">
                <button @click="showTutorialModal = false" class="px-8 py-3 bg-violet-600 text-white font-bold rounded-xl hover:bg-violet-700 transition shadow-lg shadow-violet-200">
                    Êàë‰∫ÜËß£‰∫ÜÔºåÈñãÂßãË®≠ÂÆö
                </button>
            </div>
        </div>
    </div>

    <!-- ÂÖ®ÂüüË®äÊÅØ Modal (Âèñ‰ª£ alert/confirm) -->
    <transition name="modal">
        <div v-if="modalState.show" class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden transform transition-all">
                <div class="p-6 text-center">
                    <div class="mx-auto mb-4 w-16 h-16 flex items-center justify-center rounded-full"
                        :class="{
                            'bg-green-100 text-green-500': modalState.type === 'success',
                            'bg-red-100 text-red-500': modalState.type === 'error',
                            'bg-yellow-100 text-yellow-500': modalState.type === 'warning',
                            'bg-blue-100 text-blue-500': modalState.type === 'info' || modalState.type === 'confirm'
                        }">
                        <i class="fa-solid text-3xl"
                           :class="{
                               'fa-check': modalState.type === 'success',
                               'fa-xmark': modalState.type === 'error',
                               'fa-exclamation': modalState.type === 'warning',
                               'fa-info': modalState.type === 'info',
                               'fa-question': modalState.type === 'confirm'
                           }"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">{{ modalState.title }}</h3>
                    <p class="text-slate-500 text-sm">{{ modalState.message }}</p>
                </div>
                <div class="bg-slate-50 px-6 py-4 flex gap-3 justify-center">
                    <template v-if="modalState.type === 'confirm'">
                         <button @click="handleCancel" class="flex-1 py-2.5 bg-white border border-slate-300 text-slate-700 font-bold rounded-xl hover:bg-slate-50 transition">ÂèñÊ∂à</button>
                         <button @click="handleConfirm" class="flex-1 py-2.5 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-200">Á¢∫Ë™ç</button>
                    </template>
                    <template v-else>
                        <button @click="handleConfirm" class="w-full py-2.5 text-white font-bold rounded-xl transition shadow-lg"
                             :class="{
                                'bg-green-500 hover:bg-green-600 shadow-green-200': modalState.type === 'success',
                                'bg-red-500 hover:bg-red-600 shadow-red-200': modalState.type === 'error',
                                'bg-yellow-500 hover:bg-yellow-600 shadow-yellow-200 text-white': modalState.type === 'warning',
                                'bg-blue-500 hover:bg-blue-600 shadow-blue-200': modalState.type === 'info'
                             }">
                            Á¢∫ÂÆö
                        </button>
                    </template>
                </div>
            </div>
        </div>
    </transition>

    <!-- AI ÁîüÊàê‰∏≠ Loading Overlay -->
    <transition name="fade">
        <div v-if="isGenerating" class="fixed inset-0 z-[99] bg-gradient-to-br from-violet-900/80 to-indigo-900/80 backdrop-blur-sm flex items-center justify-center">
            <div class="bg-white/95 rounded-3xl shadow-2xl p-8 max-w-sm w-full mx-4 text-center transform transition-all">
                <div class="mb-6">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-violet-500 to-indigo-600 rounded-full mb-4 animate-pulse">
                        <i class="fa-solid fa-robot text-white text-3xl"></i>
                    </div>
                    <div class="flex justify-center gap-2 mb-4">
                        <div class="w-3 h-3 bg-violet-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-3 h-3 bg-indigo-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-3 h-3 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                </div>
                <h3 class="text-2xl font-bold text-slate-800 mb-2">AI ÁîüÊàê‰∏≠</h3>
                <p class="text-slate-600 text-sm">Ê≠£Âú®‰ΩøÁî® AI ÁÇ∫ÊÇ®ÁîüÊàêÂÖßÂÆπÔºåË´ãÁ®çÂÄô...</p>
                <div class="mt-3 inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-violet-100 to-indigo-100 rounded-full">
                    <i class="fa-solid fa-robot text-violet-600 mr-2 text-sm"></i>
                    <span class="text-xs font-bold text-violet-700">{{ currentModelName }}</span>
                </div>
                <div class="mt-4 text-xs text-slate-400">
                    <i class="fa-solid fa-circle-notch fa-spin mr-1"></i>
                    ÈÄôÂèØËÉΩÈúÄË¶ÅÂπæÁßíÈêòÊôÇÈñì
                </div>
            </div>
        </div>
    </transition>

    <!-- Large QR Code Modal -->
    <transition name="fade">
        <div v-if="showQrModal" @click="closeQrModal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 cursor-pointer">
            <div @click.stop class="bg-white p-6 sm:p-8 rounded-2xl shadow-2xl flex flex-col items-center gap-4 cursor-default">
                <h3 class="text-xl font-bold text-slate-800">{{ qrModalTitle }}</h3>
                <div id="modal-qrcode-large"></div>
                <p class="text-sm text-slate-500">ÈªûÊìäÁï´Èù¢‰ªªÊÑèËôïÈóúÈñâ</p>
            </div>
        </div>
    </transition>

</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<!-- ============================================================================
     Firebase Ë®≠ÂÆöÂçÄ - ‰æõ„ÄåfirebaseË®≠ÂÆöÂ∑•ÂÖ∑.html„ÄçË≠òÂà•ÂíåÊõ¥Êñ∞
     Ê≠§ÂçÄÂ°äÂèØÈÄèÈÅé firebaseË®≠ÂÆöÂ∑•ÂÖ∑.html Ëá™ÂãïÊõ¥Êñ∞
     ============================================================================ -->
<script type="module">
// ============================================================================
// „ÄêFirebase Ë®≠ÂÆöÂçÄ„Äë- ÂÇôÁî®Ë®≠ÂÆöÔºàÂÑ™ÂÖàÊ¨äÊúÄ‰ΩéÔºâ
// ============================================================================
// ‰ΩøÁî®ÊñπÂºèÔºöÂ∞á‰∏ãÊñπÂÖ≠Ë°å "demo" Áõ¥Êé•Âèñ‰ª£ÁÇ∫ÊÇ®ÁöÑ Firebase Ë®≠ÂÆöÂÄº
//
// 1. ÂâçÂæÄ Firebase Console > Â∞àÊ°àË®≠ÂÆö > ‰∏ÄËà¨Ë®≠ÂÆö
// 2. Âú®„ÄåÊÇ®ÁöÑÊáâÁî®Á®ãÂºè„ÄçÂçÄÂ°äÊâæÂà∞ firebaseConfig
// 3. Ë§áË£ΩÂ∞çÊáâÁöÑÂÄºÔºåÂèñ‰ª£‰∏ãÊñπÁöÑ "demo"
//
// ÂÑ™ÂÖàÈ†ÜÂ∫èÔºöURL ÂèÉÊï∏ > localStorage > Ê≠§Ë®≠ÂÆö
// Â¶ÇÊûú‰∏äËø∞‰æÜÊ∫êÈÉΩÊ≤íÊúâË®≠ÂÆöÔºåÊâçÊúÉ‰ΩøÁî®ÈÄôË£°ÁöÑÂÄº
//
// Ê≥®ÊÑèÔºöÊ≠§Ë®≠ÂÆöÂçÄÂ°äÊúÉË¢´Ëá™ÂãïÂêåÊ≠•Âà∞‰∏ãÊñπÁöÑ‰∏ªÁ®ãÂºèÂçÄÂ°ä‰∏≠
// ============================================================================
const __firebaseConfig = {
  apiKey: "demo",
  authDomain: "demo",
  projectId: "demo",
  storageBucket: "demo",
  messagingSenderId: "demo",
  appId: "demo"
};
// ============================================================================

// Â∞áÈÖçÁΩÆÂ≠òÂÑ≤Âà∞ window Â∞çË±°Ôºå‰æõ‰∏ªËÖ≥Êú¨‰ΩøÁî®
window.__manualFirebaseConfig = __firebaseConfig;
console.log("Firebase ÈÖçÁΩÆÂ∑≤ËºâÂÖ•Âà∞ window.__manualFirebaseConfig:", window.__manualFirebaseConfig);
</script>

<script>
const { createApp, ref, reactive, computed, onMounted, nextTick, watch } = Vue;

createApp({
    setup() {
        // ============================================================================
        // „ÄêFirebase Ë®≠ÂÆöÂçÄ„Äë- ÂÇôÁî®Ë®≠ÂÆöÔºàÂÑ™ÂÖàÊ¨äÊúÄ‰ΩéÔºâ
        // ============================================================================
        // ‰ΩøÁî®ÊñπÂºèÔºöÂ∞á‰∏ãÊñπÂÖ≠Ë°å "demo" Áõ¥Êé•Âèñ‰ª£ÁÇ∫ÊÇ®ÁöÑ Firebase Ë®≠ÂÆöÂÄº
        //
        // Ê≥®ÊÑèÔºöÊ≠§Ë®≠ÂÆöÊáâËàá‰∏äÊñπ <script type="module"> ‰∏≠ÁöÑË®≠ÂÆö‰øùÊåÅ‰∏ÄËá¥
        // firebaseË®≠ÂÆöÂ∑•ÂÖ∑.html ÊúÉËá™ÂãïÊõ¥Êñ∞‰∏äÊñπÁöÑË®≠ÂÆöÂçÄÂ°ä
        // ÂÑ™ÂÖàÈ†ÜÂ∫èÔºöURL ÂèÉÊï∏ > localStorage > Ê≠§Á°¨Á∑®Á¢ºË®≠ÂÆö
        //
        // ÂÑ™ÂÖàÂæû window.__manualFirebaseConfig ËÆÄÂèñÔºàÁî±‰∏äÊñπÁöÑ <script type="module"> Ë®≠ÂÆöÔºâ
        // Â¶ÇÊûú‰∏çÂ≠òÂú®ÔºåÂâá‰ΩøÁî®‰∏ãÊñπÁöÑÂÇôÁî®ÈÖçÁΩÆ
        // ============================================================================
        const manualConfig = window.__manualFirebaseConfig || {
            apiKey: "demo",
            authDomain: "demo",
            projectId: "demo",
            storageBucket: "demo",
            messagingSenderId: "demo",
            appId: "demo"
        };
        // ============================================================================

        // --- Global Message Modal State ---
        const modalState = reactive({
            show: false,
            title: '',
            message: '',
            type: 'info', // success, error, warning, info, confirm
            resolve: null,
            reject: null
        });

        // Helper: Show Alert
        const showAlert = (title, message, type = 'info') => {
            modalState.title = title;
            modalState.message = message;
            modalState.type = type;
            modalState.show = true;
            modalState.resolve = null;
        };

        // Helper: Show Confirm
        const showConfirm = (title, message) => {
            return new Promise((resolve, reject) => {
                modalState.title = title;
                modalState.message = message;
                modalState.type = 'confirm';
                modalState.show = true;
                modalState.resolve = resolve;
                modalState.reject = reject;
            });
        };

        const handleConfirm = () => {
            modalState.show = false;
            if (modalState.resolve) modalState.resolve(true);
        };

        const handleCancel = () => {
            modalState.show = false;
            if (modalState.resolve) modalState.resolve(false);
        };


        // --- State ---
        const configInput = ref('');
        const isConfigured = ref(false);
        const currentView = ref('landing'); 
        
        // Settings & AI
        const customApiKey = ref(localStorage.getItem('custom_api_key') || '');
        const selectedModel = ref(localStorage.getItem('selected_model') || 'gemini-2.5-flash-preview-09-2025');
        const showSettingsModal = ref(false);
        const showConfigEdit = ref(false); 
        const showTutorialModal = ref(false);
        const shareUrl = ref('');
        const studentShareUrl = ref('');
        const isStudentView = ref(false);

        // QR Code Modal
        const showQrModal = ref(false);
        const qrModalContent = ref('');
        const qrModalTitle = ref('');

        // Teacher
        const teacherPassword = ref('');
        const quizzes = ref([]);
        const showCreateQuiz = ref(false);
        const editingQuizId = ref(null); // Track which quiz is being edited
        const createMode = ref('ai');
        const aiSourceText = ref('');
        const aiImageBase64 = ref('');
        const isPdfLoading = ref(false);
        const isGenerating = ref(false);
        const manualInput = ref('');
        const aiConfig = reactive({ easy: 2, medium: 2, hard: 1 });
        const newQuiz = reactive({ 
            title: '', 
            category: '', 
            questions: [],
            questionType: 'multiple-choice',
            readingPassage: '' // For reading comprehension
        });
        
        // Reading comprehension configuration
        const readingConfig = reactive({
            textSource: 'paste', // 'paste', 'upload', 'topic'
            topic: '',
            language: 'ÁπÅ‰∏≠', // 'ÁπÅ‰∏≠', 'Ëã±Êñá', 'Êó•Êñá', 'ÈüìÊñá'
            pirlsLevels: {
                retrieval: 2, // ÊèêÂèñË®äÊÅØ
                inference: 2, // Êé®Ë´ñÁêÜËß£
                interpretation: 1, // Ë©ÆÈáãÊï¥Âêà
                evaluation: 1 // Ë©ï‰º∞ÈëëË≥û
            }
        });
        
        // Question Editor
        const showQuestionEditor = ref(false);
        const currentEditingQuestion = reactive({ title: '', options: ['', '', '', ''], answer: 1, difficulty: '‰∏ÄËà¨', explanation: '' });
        const currentEditingQuestionIndex = ref(-1);

        // Category Filter
        const selectedCategory = ref('All');

        // Analytics
        const showAnalytics = ref(false);
        const analyticsTab = ref('score'); // 'score' or 'question'
        const selectedAnalyticsQuiz = ref(null);
        const analyticsData = ref([]);
        const selectedStudentResult = ref(null); 

        // Student & Global State
        const studentName = ref('');
        const selectedQuizId = ref(''); // ‰øùÁïôËÆäÊï∏‰ΩÜ‰∏ªË¶Å‰æùË≥¥ activeQuizId
        const activeQuizId = ref(null); // ÂÖ®ÂüüÂïüÁî®‰∏≠ÁöÑ Quiz ID
        const activeQuiz = ref(null);
        const currentQuestionIndex = ref(0);
        const studentAnswers = ref([]);
        const currentAnswer = ref(null);
        const score = ref(0);

        // Firebase Refs
        let db = null;
        let auth = null;
        let user = ref(null);
        let appId = null;

        // --- Êõ¥Êñ∞Êó•Ë™å ---
        const updateLog = ref([
            { date: '2025/12/04', desc: 'Êñ∞Â¢ûÂ≠∏ÁîüÂ∞àÁî®ÂàÜ‰∫´ÈÄ£ÁµêÔºåÈñãÂïüÂæåÂ∞áÈö±ËóèÊïôÂ∏´ÂÖ•Âè£ËàáË®≠ÂÆöÔºõ‰øÆÂæ© iPad Ëû¢ÂÖâÁ≠ÜÂäüËÉΩÔºõÁ∞°Âåñ AI API Ë®≠ÂÆö„ÄÇ' },
            { date: '2025/12/04', desc: 'ÊïôÂ∏´ÂÑÄË°®ÊùøÂ¢ûÂä†È°ØÁ§∫ÁõÆÂâçÂïüÁî®È°åÂ∫´ÂèäÁµêÊùüÊ∏¨È©óÊåâÈàï„ÄÇ' },
            { date: '2025/12/04', desc: 'Êñ∞Â¢ûÈ°åÂ∫´ÂÖßÂÆπÁ∑®ËºØÂèäÂà™Èô§ÂñÆÈ°åÂäüËÉΩ„ÄÇ' },
            { date: '2025/12/04', desc: 'Êñ∞Â¢ûÂàÜÈ°ûÁØ©ÈÅ∏ÂèäÈ°åÂ∫´Ë§áË£ΩÂäüËÉΩ„ÄÇ' },
            { date: '2025/12/04', desc: 'ÂàÜÊûêÂ†±ÂëäÊñ∞Â¢ûË©¶È°åÂàÜÊûêÈ†ÅÈù¢ (Á≠îÂ∞çÁéáÂèäÁ≠îÈåØÂêçÂñÆ)„ÄÇ' },
            { date: '2025/12/04', desc: 'Êñ∞Â¢ûÊàêÁ∏æÂ†±Ë°® CSV ‰∏ãËºâÂäüËÉΩ„ÄÇ' },
            { date: '2025/12/04', desc: '‰øÆÂæ© Firestore Ë§áÂêàÊü•Ë©¢Á¥¢ÂºïÈåØË™§ÔºåÊîπÁÇ∫ÂÆ¢Êà∂Á´ØÊéíÂ∫è„ÄÇ' },
            { date: '2025/12/04', desc: 'ÊâÄÊúâË≠¶ÂëäÂèäÁ¢∫Ë™çË®äÊÅØÊîπÁÇ∫ÂúñÂ±§ Modal È°ØÁ§∫ (ÁßªÈô§ alert/confirm)„ÄÇ' },
            { date: '2025/12/03', desc: 'Êñ∞Â¢û PDF ‰∏äÂÇ≥Ëß£ÊûêÂäüËÉΩ„ÄÇ' },
            { date: '2025/12/03', desc: 'Â∞á Firebase Config Ë®≠ÁΩÆÊîπÁÇ∫ÊâãÂãï/ÂØ´Ê≠ªÊ®°ÂºèÔºåÁßªÈô§ÂàùÂßãÂåñÈÅÆÁΩ©„ÄÇ' },
            { date: '2025/12/02', desc: 'Â∞àÊ°àÂª∫Á´ãÔºåÂåÖÂê´ Firebase ÂåøÂêçÁôªÂÖ•„ÄÅAI Âá∫È°å„ÄÅÂ∏´Áîü‰ªãÈù¢ÂèäÊàêÁ∏æÂàÜÊûêÂúñË°®„ÄÇ' }
        ]);

        // --- Initialization ---
        onMounted(async () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('mode') && urlParams.get('mode') === 'student') {
                isStudentView.value = true;
            }
            await initApp();
            // If in student view and app is ready, go directly to student login
            if (isStudentView.value && isConfigured.value) {
                goToView('student-login');
            }
        });

        const initApp = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const encryptedConfig = urlParams.get('config');

            // ÂÑ™ÂÖàÈ†ÜÂ∫è 1: URL ÂèÉÊï∏ÊúÄÂÑ™ÂÖà
            if (encryptedConfig) {
                try {
                    const decoded = atob(encryptedConfig);
                    const configObj = JSON.parse(decoded);
                    localStorage.setItem('firebase_config', JSON.stringify(configObj));
                    initializeFirebase(configObj);
                    // Clean URL, but preserve student mode
                    const cleanUrl = window.location.pathname + (urlParams.has('mode') ? '?mode=student' : '');
                    window.history.replaceState({}, document.title, cleanUrl);
                    console.log("Â∑≤Âæû URL ÂèÉÊï∏Ëá™ÂãïËºâÂÖ•‰∏¶Â•óÁî® Firebase Ë®≠ÂÆö„ÄÇ");
                    return;
                } catch (e) {
                    console.error("URL config decode failed", e);
                }
            }

            // ÂÑ™ÂÖàÈ†ÜÂ∫è 2: localStorage
            const storedConfig = localStorage.getItem('firebase_config');
            if (storedConfig) {
                try {
                    const config = JSON.parse(storedConfig);
                    if (config && config.apiKey) {
                        initializeFirebase(config);
                        console.log("Â∑≤Âæû localStorage Ëá™ÂãïËºâÂÖ•‰∏¶Â•óÁî® Firebase Ë®≠ÂÆö„ÄÇ");
                        return;
                    }
                } catch (e) {
                    localStorage.removeItem('firebase_config');
                    console.error("localStorage config parse failed", e);
                }
            }

            // ÂÑ™ÂÖàÈ†ÜÂ∫è 3: Á°¨Á∑®Á¢ºË®≠ÂÆöÔºàÊúÄ‰ΩéÂÑ™ÂÖàÊ¨äÔºâ
            // ÈáçÊñ∞Ê™¢Êü• window.__manualFirebaseConfigÔºàÂèØËÉΩÂú® module script ‰∏≠Ë®≠ÂÆöÔºâ
            const finalConfig = window.__manualFirebaseConfig || manualConfig;

            console.log("Ê™¢Êü•Á°¨Á∑®Á¢ºÈÖçÁΩÆ:", finalConfig);
            console.log("window.__manualFirebaseConfig:", window.__manualFirebaseConfig);

            if (finalConfig && finalConfig.apiKey) {
                // ÁúüÂØ¶ÁöÑ Firebase API Key ÈÄöÂ∏∏ÊòØ 39 Â≠óÂÖÉÔºå‰ª• "AIza" ÈñãÈ†≠
                // Ê™¢Êü• apiKey ÊòØÂê¶‰∏çÊòØ "demo" ‰∏îÈï∑Â∫¶ > 10ÔºàÈÅøÂÖçÊ∏¨Ë©¶Áî®ÁöÑÂÅáÂÄºÔºâ
                const isValidApiKey = finalConfig.apiKey !== "demo" &&
                                     finalConfig.apiKey.length > 10 &&
                                     !finalConfig.apiKey.match(/^demo$/i);

                console.log("apiKey È©óË≠â:", {
                    apiKey: finalConfig.apiKey,
                    isValidApiKey: isValidApiKey,
                    length: finalConfig.apiKey.length
                });

                if (isValidApiKey) {
                    try {
                        initializeFirebase(finalConfig);
                        console.log("Â∑≤ÂæûÂéüÂßãÁ¢º‰∏≠ÁöÑÂÇôÁî®Ë®≠ÂÆöËá™ÂãïËºâÂÖ•‰∏¶Â•óÁî® Firebase Ë®≠ÂÆö„ÄÇ");
                        return;
                    } catch (e) {
                        console.error("manualConfig initialization failed", e);
                    }
                }
            }

            // Â¶ÇÊûúÊ≤íÊúâ‰ªª‰ΩïÂèØÁî®ÁöÑË®≠ÂÆöÔºå‰∏çÂÅö‰ªª‰Ωï‰∫ãÔºàÁî®Êà∂ÈúÄË¶ÅÊâãÂãïË®≠ÂÆöÔºâ
            console.log("Â∞öÊú™Ë®≠ÂÆö FirebaseÔºåË´ãÂú®Ë®≠ÂÆöÈ†ÅÈù¢‰∏≠ÈÄ≤Ë°åË®≠ÂÆö„ÄÇ");
        };

        const initializeFirebase = (config) => {
            try {
                // È©óË≠âÈÖçÁΩÆÂÆåÊï¥ÊÄß
                const requiredFields = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];

                // Ê™¢Êü•ÂøÖË¶ÅÊ¨Ñ‰ΩçÊòØÂê¶Â≠òÂú®‰∏î‰∏çÁÇ∫Á©∫
                const missingFields = requiredFields.filter(field => !config[field] || config[field].trim() === '');

                if (missingFields.length > 0) {
                    console.error("Firebase ÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåÁº∫Â∞ë‰ª•‰∏ãÊ¨Ñ‰Ωç:", missingFields);
                    showAlert("ÈÖçÁΩÆÈåØË™§", `Firebase ÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåË´ãÊ™¢Êü•‰ª•‰∏ãÊ¨Ñ‰ΩçÔºö${missingFields.join(', ')}`, "error");
                    isConfigured.value = false;
                    return;
                }

                // Ê™¢Êü• apiKey ÊòØÂê¶ÁúãËµ∑‰æÜÂÉèÁúüÂØ¶ÁöÑ Firebase API Key
                if (config.apiKey === 'demo' || (config.apiKey.length < 20 && config.apiKey.toLowerCase().includes('demo'))) {
                    console.error("Firebase apiKey ‰ºº‰πéÊú™Ë®≠ÂÆöÔºà‰ªçÁÇ∫ demo ÂÄºÔºâ");
                    showAlert("ÈÖçÁΩÆÈåØË™§", "Firebase apiKey ‰ºº‰πéÊú™Ë®≠ÂÆöÔºåË´ãÂ°´ÂÖ•ÁúüÂØ¶ÁöÑ Firebase ÈÖçÁΩÆ", "error");
                    isConfigured.value = false;
                    return;
                }

                console.log("Ê≠£Âú®ÂàùÂßãÂåñ FirebaseÔºåÈÖçÁΩÆ:", {
                    projectId: config.projectId,
                    authDomain: config.authDomain,
                    appId: config.appId
                });

                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                } else {
                    console.log("Firebase Â∑≤Á∂ìÂàùÂßãÂåñÈÅé‰∫Ü");
                }

                auth = firebase.auth();
                db = firebase.firestore();
                appId = config.appId;

                auth.onAuthStateChanged((u) => {
                    if (u) {
                        user.value = u;
                        console.log("‰ΩøÁî®ËÄÖÂ∑≤ÁôªÂÖ•:", u.uid);
                    } else {
                        console.log("ÂòóË©¶ÂåøÂêçÁôªÂÖ•...");
                        auth.signInAnonymously().catch((error) => {
                            console.error("Auth Failed", error);
                            console.error("ÈåØË™§Á¢º:", error.code);
                            console.error("ÈåØË™§Ë®äÊÅØ:", error.message);

                            let errorMsg = "Firebase Ë™çË≠âÂ§±Êïó";
                            if (error.code === 'auth/configuration-not-found') {
                                errorMsg = "Firebase ÈÖçÁΩÆÈåØË™§ÔºåË´ãÁ¢∫Ë™çÔºö\n1. Firebase Authentication Â∑≤ÂïüÁî®\n2. Â∑≤ÂïüÁî®ÂåøÂêçÁôªÂÖ•\n3. ÈÖçÁΩÆÊ¨Ñ‰ΩçÊ≠£Á¢∫";
                            } else if (error.code === 'auth/operation-not-allowed') {
                                errorMsg = "Ë´ãÂú® Firebase Console ‰∏≠ÂïüÁî®„ÄåÂåøÂêçÁôªÂÖ•„ÄçÂäüËÉΩ";
                            }

                            showAlert("Ë™çË≠âÈåØË™§", errorMsg, "error");
                            isConfigured.value = false;
                        });
                    }
                });

                // Áõ£ËÅΩÂÖ®ÂüüÂïüÁî®È°åÂ∫´ÁãÄÊÖã
                db.collection('config').doc('quizStatus').onSnapshot(doc => {
                    if (doc.exists) {
                        activeQuizId.value = doc.data().activeQuizId;
                    } else {
                        activeQuizId.value = null;
                    }
                }, (error) => {
                    console.error("Firestore Áõ£ËÅΩÂ§±Êïó:", error);
                });

                isConfigured.value = true;
                showConfigEdit.value = false;
                generateShareUrls(config);

                console.log("Firebase ÂàùÂßãÂåñÂÆåÊàê");
            } catch (e) {
                console.error("Firebase ÂàùÂßãÂåñÂ§±Êïó:", e);
                console.error("ÈåØË™§Ë©≥ÊÉÖ:", e.code, e.message);

                let errorMsg = "Firebase ÂàùÂßãÂåñÂ§±Êïó";
                if (e.code === 'app/duplicate-app') {
                    errorMsg = "Firebase Â∑≤Á∂ìÂàùÂßãÂåñÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢";
                } else if (e.message) {
                    errorMsg = `Firebase ÂàùÂßãÂåñÂ§±Êïó: ${e.message}`;
                }

                showAlert("ÈåØË™§", errorMsg, "error");
                localStorage.removeItem('firebase_config');
                isConfigured.value = false;
            }
        };

        const checkConfigAndGo = (view) => {
            if (!isConfigured.value) {
                showAlert("Á≥ªÁµ±Êú™Â∞±Á∑í", "Ë´ãÂÖàÂÆåÊàêÁ≥ªÁµ±Ë®≠ÂÆöÔºÅ\nË´ãÈªûÊìäÂè≥‰∏äËßíÁöÑ„ÄåÊú™ÈÄ£Á∑ö„ÄçÊåâÈàïÊàñÈΩíËº™ÂúñÁ§∫ÈÄ≤Ë°åË®≠ÂÆö„ÄÇ", "warning");
                showSettingsModal.value = true;
                return;
            }
            goToView(view);
        };

        const parseAndSaveConfig = () => {
            const text = configInput.value;
            const keys = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
            const config = {};
            let found = false;

            keys.forEach(key => {
                const regex = new RegExp(`${key}\\s*[:=]\\s*["']([^"']+)["']`);
                const match = text.match(regex);
                if (match) {
                    config[key] = match[1];
                    found = true;
                }
            });

            if (found && config.apiKey) {
                localStorage.setItem('firebase_config', JSON.stringify(config));
                window.location.reload();
            } else {
                showAlert("Ë®≠ÂÆöÈåØË™§", "ÁÑ°Ê≥ïËß£Êûê ConfigÔºåË´ãÁ¢∫‰øùË§áË£ΩÂÆåÊï¥ÁöÑ firebaseConfig Áâ©‰ª∂ÂÖßÂÆπ„ÄÇ", "error");
            }
        };

        let debounceTimer = null;
        const isApiKeySaved = ref(false);

        watch(customApiKey, (newValue) => {
            clearTimeout(debounceTimer);
            isApiKeySaved.value = false;
            debounceTimer = setTimeout(() => {
                localStorage.setItem('custom_api_key', newValue);
                isApiKeySaved.value = true;
                setTimeout(() => isApiKeySaved.value = false, 2000);
            }, 500);
        });

        watch(selectedModel, (newValue) => {
            localStorage.setItem('selected_model', newValue);
        });

        const getApiUrl = () => {
            const key = customApiKey.value;
            const model = selectedModel.value;
            return `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
        };

        const generateShareUrls = (config) => {
            const jsonStr = JSON.stringify(config);
            const b64 = btoa(jsonStr);
            const baseUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}`;
            
            shareUrl.value = `${baseUrl}?config=${b64}`;
            studentShareUrl.value = `${baseUrl}?config=${b64}&mode=student`;
        };

        const toggleSettings = () => {
            if (isStudentView.value) return; // Safeguard
            showSettingsModal.value = !showSettingsModal.value;
            if (showSettingsModal.value && isConfigured.value) {
                nextTick(() => {
                    const teacherQrContainer = document.getElementById("qrcode");
                    if(teacherQrContainer) {
                        teacherQrContainer.innerHTML = "";
                        new QRCode(teacherQrContainer, { text: shareUrl.value, width: 100, height: 100 });
                    }
                    const studentQrContainer = document.getElementById("studentQrcode");
                    if(studentQrContainer) {
                        studentQrContainer.innerHTML = "";
                        new QRCode(studentQrContainer, { text: studentShareUrl.value, width: 100, height: 100 });
                    }
                });
            }
        };

        const resetConfig = async () => {
            const confirm = await showConfirm("Âç±Èö™Êìç‰Ωú", "Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâË®≠ÂÆö‰∏¶ÈáçÁΩÆÂóéÔºüÊ≠§Âãï‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ");
            if(confirm) {
                localStorage.clear();
                window.location.reload();
            }
        };

        const copyShareUrl = (type = 'teacher') => {
            const urlToCopy = type === 'student' ? studentShareUrl.value : shareUrl.value;
            navigator.clipboard.writeText(urlToCopy);
            showAlert("ÊàêÂäü", "ÈÄ£ÁµêÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø", "success");
        };

        const copyRules = () => {
            const rules = `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /config/quizStatus {
      allow read, write: if true;
    }
    match /quizzes/{quizId} {
      allow read: if true;
      allow create, delete: if request.auth != null;
    }
    match /results/{resultId} {
      allow create, read: if true;
    }
  }
}`;
            navigator.clipboard.writeText(rules);
            showAlert("ÊàêÂäü", "Ë¶èÂâáÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø", "success");
        };

        const openQrModal = (type) => {
            if (type === 'student') {
                qrModalTitle.value = 'Â≠∏ÁîüÂ∞àÁî®ÂàÜ‰∫´ (Á∞°Âåñ‰ªãÈù¢)';
                qrModalContent.value = studentShareUrl.value;
            } else {
                qrModalTitle.value = 'ÊïôÂ∏´Áî®ÂàÜ‰∫´ (ÂÆåÊï¥ÂäüËÉΩ)';
                qrModalContent.value = shareUrl.value;
            }
            showQrModal.value = true;
            
            nextTick(() => {
                const qrContainer = document.getElementById('modal-qrcode-large');
                if (qrContainer) {
                    qrContainer.innerHTML = ''; // Clear previous QR code
                    new QRCode(qrContainer, {
                        text: qrModalContent.value,
                        width: 300,
                        height: 300,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }
            });
        };

        const closeQrModal = () => {
            showQrModal.value = false;
            qrModalContent.value = '';
            qrModalTitle.value = '';
        };

        // --- Navigation & Helper ---
        const goToView = (view) => {
            currentView.value = view;
            if (view === 'teacher-dashboard') fetchQuizzes();
            if (view === 'landing') {
                studentName.value = '';
                teacherPassword.value = '';
            }
        };

        const formatDate = (ts) => {
            if (!ts) return '';
            return new Date(ts.seconds * 1000).toLocaleString('zh-TW');
        };

        // --- Teacher Logic ---
        const verifyTeacher = () => {
            if (teacherPassword.value === 'tpet') {
                goToView('teacher-dashboard');
            } else {
                showAlert("ÁôªÂÖ•Â§±Êïó", "ÂØÜÁ¢ºÈåØË™§", "error");
            }
        };

        const fetchQuizzes = () => {
            if (!db) return;
            db.collection('quizzes').orderBy('createdAt', 'desc').onSnapshot(snap => {
                quizzes.value = snap.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    category: doc.data().category || 'Êú™ÂàÜÈ°û' // Default category
                }));
            });
        };

        const uniqueCategories = computed(() => {
            const cats = new Set(quizzes.value.map(q => q.category));
            return Array.from(cats).sort();
        });

        const filteredQuizzes = computed(() => {
            if (selectedCategory.value === 'All') return quizzes.value;
            return quizzes.value.filter(q => q.category === selectedCategory.value);
        });

        // Computed property to get the active quiz title
        const getActiveQuizTitle = computed(() => {
            const activeQ = quizzes.value.find(q => q.id === activeQuizId.value);
            return activeQ ? activeQ.title : 'Êú™Áü•Ê∏¨È©ó';
        });

        // Êñ∞Â¢ûÔºöÂïüÁî®È°åÂ∫´ÂäüËÉΩ
        const activateQuiz = async (quizId) => {
            try {
                await db.collection('config').doc('quizStatus').set({ activeQuizId: quizId });
                showAlert("ÂïüÁî®ÊàêÂäü", "Ê≠§È°åÂ∫´Â∑≤Ë®≠ÂÆöÁÇ∫ÈÄ≤Ë°å‰∏≠ÔºåÂ≠∏ÁîüÁèæÂú®ÂèØ‰ª•ÈÄ≤ÂÖ•‰ΩúÁ≠î„ÄÇ", "success");
            } catch (e) {
                console.error(e);
                showAlert("ÂïüÁî®Â§±Êïó", "ÁÑ°Ê≥ïË®≠ÂÆöÈ°åÂ∫´ÁãÄÊÖã", "error");
            }
        };

        // Êñ∞Â¢ûÔºöÂÅúÊ≠¢È°åÂ∫´ÂäüËÉΩ
        const deactivateQuiz = async () => {
             const confirm = await showConfirm("Á¢∫Ë™çÁµêÊùü", "Á¢∫ÂÆöË¶ÅÁµêÊùüÁõÆÂâçÁöÑÊ∏¨È©óÂóéÔºüÂ≠∏ÁîüÂ∞áÁÑ°Ê≥ïÂÜçÈÄ≤ÂÖ•‰ΩúÁ≠î„ÄÇ");
             if(confirm) {
                try {
                    await db.collection('config').doc('quizStatus').set({ activeQuizId: null });
                    showAlert("Â∑≤ÁµêÊùü", "Ê∏¨È©óÂ∑≤ÁµêÊùü„ÄÇ", "success");
                } catch (e) {
                    console.error(e);
                    showAlert("ÈåØË™§", "Êìç‰ΩúÂ§±Êïó", "error");
                }
             }
        };

        const handleImageUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    aiImageBase64.value = canvas.toDataURL('image/jpeg', 0.8);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        };

        const handlePdfUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (file.type !== 'application/pdf') {
                showAlert("Ê†ºÂºèÈåØË™§", "Ë´ã‰∏äÂÇ≥ PDF Ê™îÊ°à", "warning");
                return;
            }

            isPdfLoading.value = true;
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = "";

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(" ");
                    fullText += pageText + "\n\n";
                }

                if (aiSourceText.value) {
                     aiSourceText.value += "\n\n" + fullText.trim();
                } else {
                     aiSourceText.value = fullText.trim();
                }
                
                showAlert("Ëß£ÊûêÊàêÂäü", `ÊàêÂäüËÆÄÂèñ PDF ÂÖ± ${pdf.numPages} È†ÅÂÖßÂÆπ`, "success");
            } catch (error) {
                console.error("PDF Ëß£ÊûêÂ§±Êïó", error);
                showAlert("Ëß£ÊûêÂ§±Êïó", "PDF Ëß£ÊûêÂ§±ÊïóÔºåÂèØËÉΩÊòØÊ™îÊ°àÂä†ÂØÜÊàñÊ†ºÂºè‰∏çÊîØÊè¥", "error");
            } finally {
                isPdfLoading.value = false;
                e.target.value = '';
            }
        };

        const generateQuestions = async () => {
            if (!aiSourceText.value && !aiImageBase64.value) {
                showAlert("Áº∫Â∞ëÂÖßÂÆπ", "Ë´ãËº∏ÂÖ•ÊñáÂ≠óÊàñ‰∏äÂÇ≥ÂúñÁâá/PDF", "warning");
                return;
            }

            isGenerating.value = true;
            newQuiz.questions = []; 

            const key = customApiKey.value;
            if (!key) { 
                showAlert("API Key Áº∫Â§±", "Ë´ãÂÖàÂú®Ë®≠ÂÆö‰∏≠Ëº∏ÂÖ•ÊÇ®ÁöÑ Gemini API Key", "warning"); 
                isGenerating.value = false; 
                return; 
            }

            const prompt = `
                ‰Ω†ÊòØ‰∏Ä‰ΩçÂ∞àÊ•≠ÊïôÂ∏´„ÄÇË´ãÊ†πÊìöÊèê‰æõÁöÑÂÖßÂÆπÔºåÁîüÊàê‰∏Ä‰ªΩÈÅ∏ÊìáÈ°åÊ∏¨È©ó„ÄÇ
                
                ÈúÄÊ±ÇË®≠ÂÆö:
                - Á∞°ÂñÆÈ°åÊï∏: ${aiConfig.easy}
                - ‰∏ÄËà¨È°åÊï∏: ${aiConfig.medium}
                - Âõ∞Èõ£È°åÊï∏: ${aiConfig.hard}
                - Ë™ûË®Ä: ÁπÅÈ´î‰∏≠Êñá (Traditional Chinese)
                
                Ëº∏Âá∫Ê†ºÂºèÂøÖÈ†àÊòØÂö¥Ê†ºÁöÑ JSON ArrayÔºå‰∏çË¶Å Markdown Ê®ôË®òÔºåÊ†ºÂºèÂ¶Ç‰∏ã:
                [
                    {
                        "title": "È°åÁõÆÂÖßÂÆπ",
                        "options": ["ÈÅ∏È†ÖA", "ÈÅ∏È†ÖB", "ÈÅ∏È†ÖC", "ÈÅ∏È†ÖD"],
                        "answer": 1, // 1‰ª£Ë°®A, 2‰ª£Ë°®B...
                        "difficulty": "Á∞°ÂñÆ",
                        "explanation": "Ëß£ÊûêÂÖßÂÆπ"
                    }
                ]
            `;

            const contents = [{
                parts: [{ text: prompt }]
            }];

            if (aiSourceText.value) contents[0].parts.push({ text: `ÊñáÊú¨ÂÖßÂÆπ:\n${aiSourceText.value}` });
            if (aiImageBase64.value) {
                const base64Data = aiImageBase64.value.split(',')[1];
                contents[0].parts.push({
                    inlineData: { mimeType: "image/jpeg", data: base64Data }
                });
            }

            try {
                const url = getApiUrl();
                const resp = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents })
                });

                const data = await resp.json();
                
                if (data.error) throw new Error(data.error.message);
                
                let text = data.candidates[0].content.parts[0].text;
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const questions = JSON.parse(text);
                newQuiz.questions = questions;
            } catch (e) {
                console.error(e);
                showAlert("ÁîüÊàêÂ§±Êïó", "AI Âá∫È°åÂ§±Êïó: " + e.message, "error");
            } finally {
                isGenerating.value = false;
            }
        };

        const parseManualInput = () => {
            const lines = manualInput.value.split('\n').filter(l => l.trim());
            const parsedQuestions = [];
            
            lines.forEach(line => {
                const parts = line.split(/[\t,]/).map(p => p.trim());
                if (parts.length >= 6) {
                    const title = parts[0];
                    let ansRaw = parts[1].toLowerCase();
                    const options = parts.slice(2, 6);
                    const explanation = parts[6] || '';
                    
                    let answer = 1;
                    if (['a','1'].includes(ansRaw)) answer = 1;
                    else if (['b','2'].includes(ansRaw)) answer = 2;
                    else if (['c','3'].includes(ansRaw)) answer = 3;
                    else if (['d','4'].includes(ansRaw)) answer = 4;
                    
                    parsedQuestions.push({
                        title, options, answer, explanation, difficulty: '‰∏ÄËà¨'
                    });
                }
            });
            
            if (parsedQuestions.length === 0) {
                showAlert("Ëß£ÊûêÈåØË™§", "Ê†ºÂºèÁÑ°Ê≥ïËß£ÊûêÔºåË´ãÊ™¢Êü•ÂàÜÈöîÁ¨¶Ëôü", "error");
            } else {
                newQuiz.questions.push(...parsedQuestions);
                showAlert("Ëß£ÊûêÊàêÂäü", `ÊàêÂäüÂä†ÂÖ• ${parsedQuestions.length} È°å`, "success");
                manualInput.value = ''; // Clear input after adding
            }
        };

        const openCreateModal = () => {
            editingQuizId.value = null; // Reset editing state
            newQuiz.title = '';
            newQuiz.category = '';
            newQuiz.questions = [];
            newQuiz.questionType = 'multiple-choice';
            newQuiz.readingPassage = '';
            aiSourceText.value = '';
            aiImageBase64.value = '';
            manualInput.value = '';
            // Reset reading config
            readingConfig.textSource = 'paste';
            readingConfig.topic = '';
            readingConfig.language = 'ÁπÅ‰∏≠';
            readingConfig.pirlsLevels = { retrieval: 2, inference: 2, interpretation: 1, evaluation: 1 };
            showCreateQuiz.value = true;
        };
        
        // Reading comprehension functions
        const canGenerateReading = computed(() => {
            const hasContent = newQuiz.readingPassage.trim();
            const hasQuestions = Object.values(readingConfig.pirlsLevels).some(level => level > 0);
            return hasContent && hasQuestions;
        });

        const currentModelName = computed(() => {
            const modelMap = {
                'gemini-2.5-flash-preview-09-2025': 'Gemini 2.5 Flash',
                'gemma-3-27b-it': 'Gemma 3 27B IT'
            };
            return modelMap[selectedModel.value] || selectedModel.value;
        });

        const handleTextFileUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                newQuiz.readingPassage = text;
                showAlert("‰∏äÂÇ≥ÊàêÂäü", "ÊñáÊú¨Ê™îÊ°àÂ∑≤‰∏äÂÇ≥", "success");
            } catch (error) {
                showAlert("‰∏äÂÇ≥Â§±Êïó", "ÁÑ°Ê≥ïËÆÄÂèñÊ™îÊ°àÂÖßÂÆπ", "error");
            }
        };
        
        const generateReadingComprehension = async () => {
            if (!canGenerateReading.value) return;

            const passageText = newQuiz.readingPassage.trim();

            if (!passageText) {
                showAlert("ÈåØË™§", "Ë´ãÂÖàÊèê‰æõÈñ±ËÆÄÊñáÊú¨", "warning");
                return;
            }

            // Generate questions using AI
            await generateReadingQuestions(passageText);
        };
        
        const generatePassageFromTopic = async () => {
            isGenerating.value = true;
            try {
                const key = customApiKey.value;
                if (!key) {
                    showAlert("API Key Áº∫Â§±", "Ë´ãÂÖàÂú®Ë®≠ÂÆö‰∏≠Ëº∏ÂÖ•ÊÇ®ÁöÑ Gemini API Key", "warning");
                    isGenerating.value = false;
                    return;
                }

                // Ë™ûË®ÄÊò†Â∞Ñ
                const languageMap = {
                    'ÁπÅ‰∏≠': 'Traditional Chinese (ÁπÅÈ´î‰∏≠Êñá)',
                    'Ëã±Êñá': 'English',
                    'Êó•Êñá': 'Japanese (Êó•Êú¨Ë™û)',
                    'ÈüìÊñá': 'Korean (ÌïúÍµ≠Ïñ¥)'
                };
                const targetLanguage = languageMap[readingConfig.language] || 'Traditional Chinese (ÁπÅÈ´î‰∏≠Êñá)';

                const prompt = `Please generate a reading passage about "${readingConfig.topic}" in ${targetLanguage}. The passage should be suitable for middle school students, approximately 300-500 words, educational and engaging. Output only the text content without any title or explanation.`;

                const contents = [{
                    parts: [{ text: prompt }]
                }];

                const url = getApiUrl();
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents })
                });

                const data = await response.json();

                if (data.error) throw new Error(data.error.message);

                const result = data.candidates[0].content.parts[0].text.trim();
                newQuiz.readingPassage = result;
                showAlert("ÁîüÊàêÊàêÂäü", "Èñ±ËÆÄÊñáÊú¨Â∑≤ÁîüÊàêÔºåÊÇ®ÂèØ‰ª•Êü•ÁúãÂíå‰øÆÊîπÂæåÂÜçÁîüÊàêÈ°åÁõÆ", "success");

            } catch (error) {
                console.error('Generate passage error:', error);
                showAlert("ÁîüÊàêÂ§±Êïó", "ÁÑ°Ê≥ïÁîüÊàêÊñáÊú¨: " + error.message, "error");
            } finally {
                isGenerating.value = false;
            }
        };
        
        const generateReadingQuestions = async (passageText) => {
            isGenerating.value = true;

            try {
                const key = customApiKey.value;
                if (!key) {
                    showAlert("API Key Áº∫Â§±", "Ë´ãÂÖàÂú®Ë®≠ÂÆö‰∏≠Ëº∏ÂÖ•ÊÇ®ÁöÑ Gemini API Key", "warning");
                    isGenerating.value = false;
                    return;
                }

                // Ë™ûË®ÄÊò†Â∞Ñ
                const languageMap = {
                    'ÁπÅ‰∏≠': 'Traditional Chinese (ÁπÅÈ´î‰∏≠Êñá)',
                    'Ëã±Êñá': 'English',
                    'Êó•Êñá': 'Japanese (Êó•Êú¨Ë™û)',
                    'ÈüìÊñá': 'Korean (ÌïúÍµ≠Ïñ¥)'
                };
                const targetLanguage = languageMap[readingConfig.language] || 'Traditional Chinese (ÁπÅÈ´î‰∏≠Êñá)';

                // PIRLSÂ±§Ê¨°Ë™™ÊòéÔºàËã±ÊñáÁâàÊú¨ÔºåËÆìAIÁêÜËß£Ôºâ
                const pirlsPrompts = {
                    retrieval: "Retrieval: Finding explicitly stated information, facts, and details from the text",
                    inference: "Inference: Making simple inferences and logical reasoning based on the text",
                    interpretation: "Interpretation: Integrating information from different parts of the text to understand main ideas and meanings",
                    evaluation: "Evaluation: Evaluating the content, critically thinking about the author's viewpoint and writing techniques"
                };

                const totalQuestions = Object.values(readingConfig.pirlsLevels).reduce((sum, count) => sum + count, 0);

                let prompt = `Generate ${totalQuestions} multiple-choice questions based on the following reading passage in ${targetLanguage}. Follow the PIRLS reading comprehension framework:

Text:
${passageText}

Question distribution by PIRLS levels:
`;

                for (const [level, count] of Object.entries(readingConfig.pirlsLevels)) {
                    if (count > 0) {
                        prompt += `- ${pirlsPrompts[level]}: ${count} questions\n`;
                    }
                }

                prompt += `
IMPORTANT: Output must be in ${targetLanguage}. All questions, options, and explanations must be in ${targetLanguage}.

Output format must be a strict JSON Array without Markdown markers:
[
  {
    "title": "Question content in ${targetLanguage}",
    "options": ["Option A in ${targetLanguage}", "Option B in ${targetLanguage}", "Option C in ${targetLanguage}", "Option D in ${targetLanguage}"],
    "answer": Correct answer number (1-4),
    "difficulty": "Á∞°ÂñÆ/‰∏ÄËà¨/Âõ∞Èõ£" (or equivalent in ${targetLanguage}),
    "explanation": "Detailed explanation in ${targetLanguage}",
    "pirlsLevel": "retrieval/inference/interpretation/evaluation"
  }
]`;

                const contents = [{
                    parts: [{ text: prompt }]
                }];

                const url = getApiUrl();
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents })
                });

                const data = await response.json();

                if (data.error) throw new Error(data.error.message);

                let text = data.candidates[0].content.parts[0].text;
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();

                const questions = JSON.parse(text);
                newQuiz.questions = questions;

                showAlert("ÁîüÊàêÊàêÂäü", `Â∑≤ÁîüÊàê${questions.length}ÈÅìÈñ±ËÆÄÊ∏¨È©óÈ°åÁõÆ`, "success");

            } catch (error) {
                console.error('Generate questions error:', error);
                showAlert("ÁîüÊàêÂ§±Êïó", "ÁÑ°Ê≥ïÁîüÊàêÈ°åÁõÆ: " + error.message, "error");
            } finally {
                isGenerating.value = false;
            }
        };
        
        // Helper function for PIRLS level names
        const getPirlsLevelName = (level) => {
            const levelNames = {
                'retrieval': 'ÊèêÂèñË®äÊÅØ',
                'inference': 'Êé®Ë´ñÁêÜËß£', 
                'interpretation': 'Ë©ÆÈáãÊï¥Âêà',
                'evaluation': 'Ë©ï‰º∞ÈëëË≥û'
            };
            return levelNames[level] || level;
        };

        // Êñ∞Â¢ûÔºöÁ∑®ËºØÈ°åÂ∫´ÂäüËÉΩ
        const editQuiz = (quiz) => {
            editingQuizId.value = quiz.id;
            newQuiz.title = quiz.title;
            newQuiz.category = quiz.category;
            newQuiz.questionType = quiz.questionType || 'multiple-choice';
            newQuiz.readingPassage = quiz.readingPassage || '';
            newQuiz.questions = JSON.parse(JSON.stringify(quiz.questions)); // Deep copy to prevent mutating original before save
            
            // Clear source inputs as we are editing existing result
            aiSourceText.value = '';
            aiImageBase64.value = '';
            manualInput.value = '';
            
            showCreateQuiz.value = true;
        };

        const duplicateQuiz = (quiz) => {
            editingQuizId.value = null; // duplicating creates a NEW quiz
            newQuiz.title = quiz.title + ' (ÂâØÊú¨)';
            newQuiz.category = quiz.category;
            newQuiz.questionType = quiz.questionType || 'multiple-choice';
            newQuiz.readingPassage = quiz.readingPassage || '';
            newQuiz.questions = JSON.parse(JSON.stringify(quiz.questions));
            showCreateQuiz.value = true;
            aiSourceText.value = ''; 
            aiImageBase64.value = '';
            manualInput.value = '';
        };

        const saveQuiz = async () => {
            if (!newQuiz.title) { showAlert("Ê¨Ñ‰ΩçÁº∫Â§±", "Ë´ãËº∏ÂÖ•Ê∏¨È©óÊ®ôÈ°å", "warning"); return; }
            
            try {
                const quizData = {
                    title: newQuiz.title,
                    category: newQuiz.category || 'Êú™ÂàÜÈ°û',
                    questionType: newQuiz.questionType,
                    readingPassage: newQuiz.readingPassage,
                    questions: newQuiz.questions,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(), // Update timestamp on edit? Maybe better to keep original created, add updated. For simplicity, just update.
                    teacherId: user.value.uid
                };

                if (editingQuizId.value) {
                    // Update existing
                    await db.collection('quizzes').doc(editingQuizId.value).update(quizData);
                    showAlert("ÊàêÂäü", "È°åÂ∫´Êõ¥Êñ∞ÊàêÂäüÔºÅ", "success");
                } else {
                    // Create new
                    await db.collection('quizzes').add(quizData);
                    showAlert("ÊàêÂäü", "È°åÂ∫´Âª∫Á´ãÊàêÂäüÔºÅ", "success");
                }
                
                showCreateQuiz.value = false;
                // Reset form
                newQuiz.title = '';
                newQuiz.category = '';
                newQuiz.questions = [];
            } catch (e) {
                showAlert("ÂÑ≤Â≠òÂ§±Êïó", e.message, "error");
            }
        };

        // Question Editor Logic
        const addQuestion = () => {
            currentEditingQuestionIndex.value = -1;
            // Reset to default blank question
            Object.assign(currentEditingQuestion, { 
                title: '', 
                options: ['', '', '', ''], 
                answer: 1, 
                difficulty: '‰∏ÄËà¨', 
                explanation: '' 
            });
            showQuestionEditor.value = true;
        };

        const editQuestion = (index) => {
            currentEditingQuestionIndex.value = index;
            // Copy question data to editor
            Object.assign(currentEditingQuestion, JSON.parse(JSON.stringify(newQuiz.questions[index])));
            showQuestionEditor.value = true;
        };

        const saveQuestion = () => {
            if(!currentEditingQuestion.title) { showAlert("ÈåØË™§", "Ë´ãËº∏ÂÖ•È°åÁõÆ", "warning"); return; }
            if(currentEditingQuestion.options.some(o => !o)) { showAlert("ÈåØË™§", "Ë´ãÂ°´ÂØ´ÊâÄÊúâÈÅ∏È†Ö", "warning"); return; }

            const questionData = JSON.parse(JSON.stringify(currentEditingQuestion));

            if (currentEditingQuestionIndex.value === -1) {
                // Add new
                newQuiz.questions.push(questionData);
            } else {
                // Update existing
                newQuiz.questions[currentEditingQuestionIndex.value] = questionData;
            }
            showQuestionEditor.value = false;
        };

        const deleteQuestion = async (index) => {
            const confirm = await showConfirm("Âà™Èô§Á¢∫Ë™ç", "Á¢∫ÂÆöÂà™Èô§Ê≠§È°åÁõÆÔºü");
            if(confirm) {
                newQuiz.questions.splice(index, 1);
            }
        };

        const deleteQuiz = async (id) => {
            const confirm = await showConfirm("Âà™Èô§Á¢∫Ë™ç", "Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§È°åÂ∫´ÂóéÔºüÊ≠§Âãï‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ");
            if (confirm) {
                await db.collection('quizzes').doc(id).delete();
            }
        };

        const copyQuizLink = (id) => {
             showAlert("ÊèêÁ§∫", `Ê∏¨È©ó ID: ${id}\nÂ≠∏ÁîüÈÅ∏ÊìáÊôÇÂèØË≠òÂà•„ÄÇ`, "info");
        };

        // --- Analytics ---
        const viewAnalytics = async (quiz) => {
            selectedAnalyticsQuiz.value = quiz;
            showAnalytics.value = true;
            selectedStudentResult.value = null; // Reset detail view
            analyticsTab.value = 'score'; // Reset tab
            
            // Fix: Remove orderBy to avoid index error. Sort in client side.
            const snap = await db.collection('results')
                .where('quizId', '==', quiz.id)
                .get();
                
            const results = snap.docs.map(d => ({id: d.id, ...d.data()}));
            // Sort by score descending
            analyticsData.value = results.sort((a, b) => b.score - a.score);
            
            nextTick(renderChart);
        };

        const exportCSV = () => {
            if (!analyticsData.value.length || !selectedAnalyticsQuiz.value) return;

            const quiz = selectedAnalyticsQuiz.value;
            const results = analyticsData.value;
            
            // 1. Calculate Summary
            const totalStudents = results.length;
            const totalScore = results.reduce((acc, cur) => acc + cur.score, 0);
            const avgScore = totalStudents > 0 ? (totalScore / totalStudents).toFixed(1) : 0;

            // 2. Build CSV Content
            let csvContent = "\uFEFF"; // BOM for Excel Chinese support
            
            // Title & Summary
            csvContent += `Ê∏¨È©óÂêçÁ®±,${quiz.title}\n`;
            csvContent += `Á∏Ω‰∫∫Êï∏,${totalStudents},Âπ≥ÂùáÂàÜÊï∏,${avgScore}\n\n`;

            // Headers
            let headers = ["Â≠∏ÁîüÂßìÂêç", "ÂæóÂàÜ", "‰∫§Âç∑ÊôÇÈñì"];
            quiz.questions.forEach((q, i) => {
                headers.push(`Q${i+1} (Ê≠£Á¢∫:${String.fromCharCode(64 + parseInt(q.answer))})`);
            });
            csvContent += headers.join(",") + "\n";

            // Rows
            results.forEach(res => {
                let row = [
                    res.studentName,
                    res.score,
                    formatDate(res.timestamp).replace(',', ' ') // Avoid comma issues
                ];

                quiz.questions.forEach((q, i) => {
                    const studentAnsIdx = res.answers[i]; // 1-based index
                    if (!studentAnsIdx) {
                        row.push("Êú™‰ΩúÁ≠î");
                    } else {
                        const letter = String.fromCharCode(64 + parseInt(studentAnsIdx));
                        const isCorrect = studentAnsIdx == q.answer;
                        row.push(isCorrect ? letter : `${letter} (X)`);
                    }
                });
                csvContent += row.join(",") + "\n";
            });

            // 3. Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `${quiz.title}_ÊàêÁ∏æÂ†±Ë°®.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const viewStudentDetails = (result) => {
            selectedStudentResult.value = result;
        };

        const closeStudentDetails = () => {
            selectedStudentResult.value = null;
        };

        const getScoreColor = (s) => {
            if (s >= 80) return 'text-green-600';
            if (s >= 60) return 'text-yellow-600';
            return 'text-red-600';
        };

        // --- Question Statistics Logic ---
        const questionStats = computed(() => {
            if (!selectedAnalyticsQuiz.value || !analyticsData.value.length) return [];
            
            return selectedAnalyticsQuiz.value.questions.map((q, idx) => {
                let correctCount = 0;
                const wrongStudents = [];
                
                analyticsData.value.forEach(res => {
                    // answers[idx] is 1-based answer index from student
                    const studentAns = res.answers ? res.answers[idx] : null;
                    if (studentAns == q.answer) {
                        correctCount++;
                    } else {
                        wrongStudents.push({
                            name: res.studentName,
                            choice: studentAns
                        });
                    }
                });
                
                const total = analyticsData.value.length;
                const rate = total === 0 ? 0 : Math.round((correctCount / total) * 100);
                
                return {
                    question: q,
                    index: idx,
                    rate,
                    wrongStudents
                };
            });
        });

        const teacherHighlightedPassage = computed(() => {
            if (!selectedAnalyticsQuiz.value || !selectedAnalyticsQuiz.value.readingPassage) {
                return '';
            }
            const text = selectedAnalyticsQuiz.value.readingPassage;

            if (!selectedStudentResult.value || !selectedStudentResult.value.highlights || selectedStudentResult.value.highlights.length === 0) {
                 return escapeHtml(text);
            }
            
            const studentHighlights = selectedStudentResult.value.highlights;
            
            const sortedHighlights = [...studentHighlights].sort((a, b) => a.start - b.start);
            
            let lastIndex = 0;
            let output = '';

            sortedHighlights.forEach(h => {
                output += escapeHtml(text.substring(lastIndex, h.start));
                output += `<mark id="teacher-highlight-${h.id}" class="highlight-${h.color}">${escapeHtml(text.substring(h.start, h.end))}</mark>`;
                lastIndex = h.end;
            });

            output += escapeHtml(text.substring(lastIndex));
            
            return output;
        });

        const renderChart = () => {
            const ctx = document.getElementById('scoreChart');
            if (!ctx) return;
            
            const scores = analyticsData.value.map(d => d.score);
            const ranges = [0, 0, 0, 0, 0]; // 0-20, 21-40, 41-60, 61-80, 81-100
            scores.forEach(s => {
                if (s <= 20) ranges[0]++;
                else if (s <= 40) ranges[1]++;
                else if (s <= 60) ranges[2]++;
                else if (s <= 80) ranges[3]++;
                else ranges[4]++;
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-20ÂàÜ', '21-40ÂàÜ', '41-60ÂàÜ', '61-80ÂàÜ', '81-100ÂàÜ'],
                    datasets: [{
                        label: '‰∫∫Êï∏ÂàÜ‰Ωà',
                        data: ranges,
                        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e'],
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        };



        // --- New Highlighter State ---
        const passageContainer = ref(null);
        const highlights = ref([]); // {start, end, color, id}
        const nextHighlightId = ref(0);

        // --- New Highlighter Functions ---
        const highlightedPassage = computed(() => {
            if (!activeQuiz.value || !activeQuiz.value.readingPassage) return '';
            
            const text = activeQuiz.value.readingPassage;
            // Sort highlights by start index to process them in order
            const sortedHighlights = [...highlights.value].sort((a, b) => a.start - b.start);
            
            let lastIndex = 0;
            let output = '';

            sortedHighlights.forEach(h => {
                // Append text before the current highlight
                output += escapeHtml(text.substring(lastIndex, h.start));
                // Append the highlighted text, wrapped in a <mark> tag
                output += `<mark id="highlight-${h.id}" data-highlight-id="${h.id}" class="highlight-${h.color}">${escapeHtml(text.substring(h.start, h.end))}</mark>`;
                lastIndex = h.end;
            });

            // Append the remaining text after the last highlight
            output += escapeHtml(text.substring(lastIndex));
            
            return output;
        });
        
        const escapeHtml = (unsafe) => {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        const getSelectionDetails = () => {
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0 || selection.isCollapsed) {
                return null;
            }

            const range = selection.getRangeAt(0);
            const container = passageContainer.value;

            // Ensure the selection is within the passage container
            if (!container || !container.contains(range.commonAncestorContainer)) {
                return null;
            }

            // Calculate the start and end offsets relative to the container's text content
            const preSelectionRange = document.createRange();
            preSelectionRange.selectNodeContents(container);
            preSelectionRange.setEnd(range.startContainer, range.startOffset);
            const start = preSelectionRange.toString().length;
            const end = start + range.toString().length;

            return { start, end };
        };

        const applyHighlight = (color) => {
            const details = getSelectionDetails();
            if (!details) {
                showAlert("ÊèêÁ§∫", "Ë´ãÂÖàÈÅ∏ÂèñÊÇ®Ë¶ÅÁï´Ë®òÁöÑÊñáÂ≠ó„ÄÇ", "info");
                return;
            }

            let { start, end } = details;

            // Merge overlapping or adjacent highlights
            let merged = false;
            highlights.value.forEach(h => {
                // Check for overlap or adjacency
                if (Math.max(h.start, start) <= Math.min(h.end, end) && h.color === color) {
                    h.start = Math.min(h.start, start);
                    h.end = Math.max(h.end, end);
                    merged = true;
                }
            });

            if (!merged) {
                // If no merge happened, add as a new highlight
                highlights.value.push({
                    id: nextHighlightId.value++,
                    start,
                    end,
                    color
                });
            }

            // After adding, clean up highlights that are fully contained within others
            const cleanedHighlights = [];
            highlights.value.sort((a,b) => a.start - b.start).forEach(h => {
                const last = cleanedHighlights[cleanedHighlights.length - 1];
                if (last && last.end >= h.end) {
                    // Current highlight is contained, do nothing
                } else if (last && last.end >= h.start && last.color === h.color) {
                    // Overlapping or adjacent, merge them
                    last.end = Math.max(last.end, h.end);
                } else {
                    cleanedHighlights.push(h);
                }
            });
            highlights.value = cleanedHighlights;


            // Deselect text
            window.getSelection().removeAllRanges();
        };

        const handlePassageClick = async (event) => {
            // Check if a highlight mark was clicked
            if (event.target.tagName === 'MARK') {
                const id = parseInt(event.target.dataset.highlightId, 10);
                const confirm = await showConfirm('ÁßªÈô§ÈáçÈªû', 'ÊÇ®Á¢∫ÂÆöË¶ÅÁßªÈô§ÈÄôÂÄãÁï´Ë®òÂóéÔºü');
                if (confirm) {
                    // Remove the highlight with the matching ID
                    highlights.value = highlights.value.filter(h => h.id !== id);
                }
            }
        };


        // --- Student Logic (Updated) ---
        const startQuiz = async () => {
            if (!activeQuizId.value) {
                showAlert("ÁÑ°Ê≥ïÈñãÂßã", "ÁõÆÂâçÊ≤íÊúâÊ≠£Âú®ÈÄ≤Ë°å‰∏≠ÁöÑÊ∏¨È©óÔºåË´ãÁ≠âÂæÖËÄÅÂ∏´ÂïüÁî®„ÄÇ", "warning");
                return;
            }

            try {
                const doc = await db.collection('quizzes').doc(activeQuizId.value).get();
                if (doc.exists) {
                    const quizData = doc.data();
                    activeQuiz.value = { id: doc.id, ...quizData };
                    currentQuestionIndex.value = 0;
                    studentAnswers.value = [];
                    currentAnswer.value = null;
                    highlights.value = []; // Clear highlights
                    nextHighlightId.value = 0; // Reset ID counter
                    goToView('quiz');
                } else {
                    showAlert("ÈåØË™§", "Êâæ‰∏çÂà∞Ë©≤Ê∏¨È©óÔºåÂèØËÉΩÂ∑≤Ë¢´Âà™Èô§„ÄÇ", "error");
                }
            } catch (e) {
                console.error(e);
                showAlert("ÈåØË™§", "ËºâÂÖ•Ê∏¨È©óÂ§±Êïó", "error");
            }
        };

        const selectAnswer = (idx) => {
            currentAnswer.value = idx;
        };
        
        const prevQuestion = () => {
            if(currentQuestionIndex.value > 0) {
                 currentQuestionIndex.value--;
                 currentAnswer.value = studentAnswers.value[currentQuestionIndex.value] || null;
            }
        };

        const nextQuestion = () => {
            if (currentAnswer.value === null) { showAlert("Ë´ãÈÅ∏Êìá", "Ë´ãÂÖàÈÅ∏Êìá‰∏ÄÂÄãÁ≠îÊ°àÂÜçÁπºÁ∫å", "warning"); return; }
            studentAnswers.value[currentQuestionIndex.value] = currentAnswer.value;
            
            currentQuestionIndex.value++;
            currentAnswer.value = studentAnswers.value[currentQuestionIndex.value] || null;
        };

        const progressPercent = computed(() => {
            if (!activeQuiz.value) return 0;
            return ((currentQuestionIndex.value + 1) / activeQuiz.value.questions.length) * 100;
        });

        const submitQuiz = async () => {
             if (currentAnswer.value === null) { showAlert("Ë´ãÈÅ∏Êìá", "Ë´ãÂÖàÈÅ∏Êìá‰∏ÄÂÄãÁ≠îÊ°à", "warning"); return; }
             studentAnswers.value[currentQuestionIndex.value] = currentAnswer.value;

             let correctCount = 0;
             activeQuiz.value.questions.forEach((q, idx) => {
                 if (q.answer == studentAnswers.value[idx]) correctCount++;
             });
             
             score.value = Math.round((correctCount / activeQuiz.value.questions.length) * 100);

             await db.collection('results').add({
                 quizId: activeQuiz.value.id,
                 studentName: studentName.value,
                 score: score.value,
                 answers: studentAnswers.value,
                 timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                 highlights: activeQuiz.value.questionType === 'reading-comprehension' ? highlights.value : []
             });

             goToView('result');
        };

        return {
            configInput, isConfigured, parseAndSaveConfig,
            customApiKey, selectedModel, showSettingsModal, showConfigEdit, showTutorialModal, shareUrl, studentShareUrl, isStudentView, openQrModal, closeQrModal, showQrModal, qrModalTitle, toggleSettings, resetConfig, copyShareUrl, copyRules, isApiKeySaved, checkConfigAndGo,
            user, currentView, goToView,
            // Modal
            modalState, showAlert, showConfirm, handleConfirm, handleCancel,
            // Teacher
            teacherPassword, verifyTeacher, quizzes, showCreateQuiz, createMode, openCreateModal, duplicateQuiz, editQuiz, editingQuizId,
            aiSourceText, aiImageBase64, isPdfLoading, isGenerating, manualInput, aiConfig, newQuiz, activeQuizId, selectedCategory, uniqueCategories, filteredQuizzes, getActiveQuizTitle,
            // Reading Comprehension
            readingConfig, canGenerateReading, currentModelName, handleTextFileUpload, generateReadingComprehension, generatePassageFromTopic, generateReadingQuestions, getPirlsLevelName,
            // Question Editor
            showQuestionEditor, currentEditingQuestion, currentEditingQuestionIndex, addQuestion, editQuestion, saveQuestion, deleteQuestion,
            handleImageUpload, handlePdfUpload, generateQuestions, parseManualInput, saveQuiz, deleteQuiz, activateQuiz, deactivateQuiz, formatDate,
            // Analytics
            viewAnalytics, showAnalytics, selectedAnalyticsQuiz, analyticsData, analyticsTab, questionStats, teacherHighlightedPassage, getScoreColor, selectedStudentResult, viewStudentDetails, closeStudentDetails, exportCSV,
            // Student
            studentName, selectedQuizId, startQuiz,
            activeQuiz, currentQuestionIndex, currentAnswer, selectAnswer, nextQuestion, prevQuestion, submitQuiz,
            progressPercent, score, studentAnswers,
            // Highlighter
            passageContainer, highlights, highlightedPassage, applyHighlight, handlePassageClick,
            // Logs
            updateLog
        };
    }
}).mount('#app');
</script>

</body>
</html>